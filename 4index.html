<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Merge Game 2.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        /* --- –°–¢–ò–õ–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê --- */
        body { margin: 0; padding: 0; overflow: hidden; background: #121212; font-family: 'Segoe UI', sans-serif; touch-action: none; color: white; }
        #game-container { position: relative; width: 100vw; height: 100vh; }

        /* –°–õ–û–ò */
        .layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .interactive { pointer-events: auto; }

        /* HUD (–°—á–µ—Ç –∏ –ë–∞—Ñ—Ñ—ã) */
        #hud { display: flex; justify-content: space-between; padding: 20px; box-sizing: border-box; z-index: 5; }
        .score-box { font-size: 24px; font-weight: bold; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .next-ball { width: 40px; height: 40px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.3); }

        /* –ö–Ω–æ–ø–∫–∞ –ë–ê–§–§–ê */
        #buff-btn {
            background: #444; color: #888; border: 2px solid #555;
            padding: 10px 20px; border-radius: 20px; font-weight: bold;
            transition: 0.3s; pointer-events: auto; display: flex; align-items: center; gap: 10px;
        }
        #buff-btn.active {
            background: linear-gradient(45deg, #ff0055, #ffcc00);
            color: white; border: 2px solid #fff;
            box-shadow: 0 0 15px #ff0055; animation: pulse 1.5s infinite; cursor: pointer;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* –ú–ï–ù–Æ */
        .menu-overlay {
            background: rgba(0,0,0,0.95); z-index: 20; display: flex; flex-direction: column;
            align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .hidden { display: none !important; }

        h1 { margin-bottom: 30px; font-size: 40px; background: -webkit-linear-gradient(#eee, #333); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .menu-btn {
            background: #333; color: white; border: 1px solid #555;
            width: 200px; padding: 15px; margin: 10px; border-radius: 12px;
            font-size: 18px; cursor: pointer; transition: 0.2s;
        }
        .menu-btn:active { transform: scale(0.95); }
        .btn-primary { background: #0088cc; border: none; font-weight: bold; }

        /* –°–ü–ò–°–ö–ò (–°–∫–∏–Ω—ã, –õ–∏–¥–µ—Ä–±–æ—Ä–¥) */
        .scroll-list {
            width: 80%; max-height: 50%; overflow-y: auto;
            background: #222; border-radius: 10px; padding: 10px; margin-bottom: 20px;
        }
        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; border-bottom: 1px solid #333; cursor: pointer;
        }
        .list-item.selected { background: #004466; }
        .rank { font-weight: bold; color: #ffcc00; margin-right: 10px; }

        /* –≠—Ñ—Ñ–µ–∫—Ç –∫—É—Ä—Å–æ—Ä–∞ –¥–ª—è –±–∞—Ñ—Ñ–∞ */
        .destroy-cursor { cursor: crosshair !important; }
    </style>
</head>
<body>

<div id="game-container">
    <!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
    <div id="main-menu" class="layer interactive menu-overlay">
        <h1>MEME DROP</h1>
        <button class="menu-btn btn-primary" onclick="Game.start()">–ò–ì–†–ê–¢–¨</button>
        <button class="menu-btn" onclick="Menu.showSkins()">–°–ö–ò–ù–´</button>
        <button class="menu-btn" onclick="Menu.showLeaderboard()">–†–ï–ö–û–†–î–´</button>
        <button class="menu-btn" onclick="Menu.showSettings()">–ù–ê–°–¢–†–û–ô–ö–ò</button>
    </div>

    <!-- –ú–ï–ù–Æ –°–ö–ò–ù–û–í -->
    <div id="skins-menu" class="layer interactive menu-overlay hidden">
        <h2>–í–´–ë–û–† –°–ö–ò–ù–ê</h2>
        <div class="scroll-list" id="skins-list"></div>
        <button class="menu-btn" onclick="Menu.backToMain()">–ù–ê–ó–ê–î</button>
    </div>

    <!-- –¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í -->
    <div id="leaderboard-menu" class="layer interactive menu-overlay hidden">
        <h2>–¢–û–ü –ò–ì–†–û–ö–û–í</h2>
        <div class="scroll-list" id="leaderboard-list"></div>
        <button class="menu-btn" onclick="Menu.backToMain()">–ù–ê–ó–ê–î</button>
    </div>

    <!-- –ú–ï–ù–Æ GAME OVER -->
    <div id="game-over-menu" class="layer interactive menu-overlay hidden">
        <h1 style="-webkit-text-fill-color: red;">GAME OVER</h1>
        <p>–°—á–µ—Ç: <span id="final-score">0</span></p>
        <button class="menu-btn btn-primary" onclick="location.reload()">–ó–ê–ù–û–í–û</button>
        <button class="menu-btn" onclick="Menu.backToMain()">–ú–ï–ù–Æ</button>
    </div>

    <!-- HUD –ò–ì–†–´ -->
    <div id="hud" class="layer hidden">
        <div>
            <div class="score-box">üèÜ <span id="score-val">0</span></div>
            <div style="font-size:12px; color:#aaa">–°–ª–µ–¥: <span id="next-ball-preview"></span></div>
        </div>

        <button id="buff-btn" onclick="Game.activateBuff()">
            üî® –£–ù–ò–ß–¢–û–ñ–ò–¢–¨
            <div style="font-size:10px; opacity:0.7">(2500 –æ—á–∫–æ–≤)</div>
        </button>
    </div>
</div>

<script>
    /* ==========================================
       –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–ù–∞—Å—Ç—Ä–æ–π –ø–æ–¥ —Å–µ–±—è –∑–¥–µ—Å—å)
       ========================================== */

    // –°—é–¥–∞ –≤—Å—Ç–∞–≤–ª—è—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ –∑–≤—É–∫–∏
    const SOUNDS_CFG = {
        merge: 'https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.m3u8', // –ü—Ä–∏–º–µ—Ä –∑–≤—É–∫–∞
        drop: null,
        gameover: null
    };

    // –°–∫–∏–Ω—ã. type: 'emoji' –∏–ª–∏ 'image'.
    // –ï—Å–ª–∏ image, –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ (path) –∏ –Ω–∞–∑–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤.
    const SKINS_DB = {
        'memes': {
            name: '–ú–µ–º—ã (Default)',
            type: 'emoji',
            levels: [
                { color: '#FFD700', label: 'ü§°', score: 2 },
                { color: '#FFA500', label: 'üí©', score: 4 },
                { color: '#FF4500', label: 'üêπ', score: 8 },
                { color: '#DC143C', label: 'ü™ô', score: 16 },
                { color: '#C71585', label: 'üí∏', score: 32 },
                { color: '#8A2BE2', label: 'üöô', score: 64 },
                { color: '#4169E1', label: 'üíé', score: 128 },
                { color: '#00BFFF', label: 'üëë', score: 256 },
                { color: '#00FA9A', label: 'üóø', score: 512 }
            ]
        },
        'fruits': {
            name: '–§—Ä—É–∫—Ç—ã (–ü—Ä–∏–º–µ—Ä)',
            type: 'emoji', // –ü–æ–º–µ–Ω—è–π –Ω–∞ 'image', –µ—Å–ª–∏ –¥–æ–±–∞–≤–∏—à—å –∫–∞—Ä—Ç–∏–Ω–∫–∏
            path: 'assets/fruits/', 
            levels: [
                { color: '#F00', label: 'üçí', file: '1.png', score: 2 },
                { color: '#F00', label: 'üçì', file: '2.png', score: 4 },
                { color: '#800080', label: 'üçá', file: '3.png', score: 8 },
                { color: '#FFA500', label: 'üçä', file: '4.png', score: 16 },
                { color: '#FFA500', label: 'ü•≠', file: '5.png', score: 32 },
                { color: '#FF0000', label: 'üçé', file: '6.png', score: 64 },
                { color: '#FFFF00', label: 'üçê', file: '7.png', score: 128 },
                { color: '#FFC0CB', label: 'üçë', file: '8.png', score: 256 },
                { color: '#008000', label: 'üçâ', file: '9.png', score: 512 }
            ]
        }
    };

    /* ==========================================
       –î–í–ò–ñ–û–ö –ò –õ–û–ì–ò–ö–ê
       ========================================== */

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let currentSkin = 'memes';
    let engine, render, runner;
    let score = 0;
    let lastBuffScore = 0;
    let isBuffActive = false;
    let gameActive = false;
    let currentBall = null;
    let canDrop = true;
    let nextBallIndex = 0; // –ö–∞–∫–æ–π —à–∞—Ä —Å–ª–µ–¥—É—é—â–∏–π

    // –†–∞–∑–º–µ—Ä—ã (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ)
    const W = window.innerWidth;
    const H = window.innerHeight;
    const BALL_SIZES = [20, 30, 40, 50, 60, 70, 80, 90, 100]; // –†–∞–¥–∏—É—Å—ã –¥–ª—è 9 —É—Ä–æ–≤–Ω–µ–π

    // –ê—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // --- –ú–ï–ù–ï–î–ñ–ï–† –ú–ï–ù–Æ ---
    const Menu = {
        hideAll: () => {
            document.querySelectorAll('.menu-overlay').forEach(el => el.classList.add('hidden'));
        },
        backToMain: () => {
            Menu.hideAll();
            document.getElementById('main-menu').classList.remove('hidden');
        },
        showSkins: () => {
            Menu.hideAll();
            document.getElementById('skins-menu').classList.remove('hidden');
            const list = document.getElementById('skins-list');
            list.innerHTML = '';
            for (let key in SKINS_DB) {
                const skin = SKINS_DB[key];
                const div = document.createElement('div');
                div.className = `list-item ${currentSkin === key ? 'selected' : ''}`;
                div.innerHTML = `<span>${skin.name}</span> <span>${skin.levels[0].label}</span>`;
                div.onclick = () => {
                    currentSkin = key;
                    localStorage.setItem('selectedSkin', key);
                    Menu.showSkins(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å
                };
                list.appendChild(div);
            }
        },
        showLeaderboard: () => {
            Menu.hideAll();
            document.getElementById('leaderboard-menu').classList.remove('hidden');
            const list = document.getElementById('leaderboard-list');
            // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∫–æ—Ä–¥—ã –∏–∑ LocalStorage (–≤ —Ä–µ–∞–ª–µ —Ç—É—Ç –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É)
            let records = JSON.parse(localStorage.getItem('leaderboard')) || [];
            records.sort((a,b) => b.score - a.score);

            list.innerHTML = '';
            if(records.length === 0) list.innerHTML = '<div style="padding:10px;text-align:center">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>';

            records.slice(0, 10).forEach((rec, i) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `<div><span class="rank">#${i+1}</span> ${rec.name}</div> <div>${rec.score}</div>`;
                list.appendChild(div);
            });
        },
        showSettings: () => {
            alert('–ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å –∑–≤—É–∫–∞ –∏ –≤–∏–±—Ä–∞—Ü–∏—é.');
        },
        showGameOver: () => {
            gameActive = false;
            document.getElementById('final-score').innerText = score;
            document.getElementById('game-over-menu').classList.remove('hidden');

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∫–æ—Ä–¥
            let records = JSON.parse(localStorage.getItem('leaderboard')) || [];
            // –¢—É—Ç –º–æ–∂–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å Telegram Username
            let name = "–ò–≥—Ä–æ–∫"; 
            if(window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe.user) {
                name = window.Telegram.WebApp.initDataUnsafe.user.first_name;
            }
            records.push({name: name, score: score, date: new Date()});
            localStorage.setItem('leaderboard', JSON.stringify(records));
        }
    };

    // --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ ---
    const Game = {
        start: () => {
            Menu.hideAll();
            document.getElementById('hud').classList.remove('hidden');

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–∏–Ω–∞
            const savedSkin = localStorage.getItem('selectedSkin');
            if(savedSkin && SKINS_DB[savedSkin]) currentSkin = savedSkin;

            Game.initPhysics();
            score = 0;
            lastBuffScore = 0;
            Game.updateUI();
            gameActive = true;
            Game.spawnNext();
        },

        initPhysics: () => {
            if(engine) { // –û—á–∏—Å—Ç–∫–∞ –µ—Å–ª–∏ —Ä–µ—Å—Ç–∞—Ä—Ç
                Matter.World.clear(engine.world);
                Matter.Engine.clear(engine);
                if(render) {
                    render.canvas.remove();
                    render.canvas = null;
                    render.context = null;
                    render.textures = {};
                }
                if(runner) Matter.Runner.stop(runner);
            }

            const Engine = Matter.Engine,
                  Render = Matter.Render,
                  Runner = Matter.Runner,
                  Bodies = Matter.Bodies,
                  World = Matter.World,
                  Events = Matter.Events;

            engine = Engine.create();

            // –†–µ–Ω–¥–µ—Ä
            render = Render.create({
                element: document.getElementById('game-container'),
                engine: engine,
                options: {
                    width: W, height: H,
                    wireframes: false, background: 'transparent' // –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π, —Ç.–∫. —Ñ–æ–Ω –≤ CSS
                }
            });

            // –°—Ç–µ–Ω—ã
            const wallOpts = { isStatic: true, render: { fillStyle: '#333' } };
            const ground = Bodies.rectangle(W/2, H+30, W, 60, wallOpts);
            const leftW = Bodies.rectangle(0, H/2, 20, H, wallOpts);
            const rightW = Bodies.rectangle(W, H/2, 20, H, wallOpts);
            World.add(engine.world, [ground, leftW, rightW]);

            // –•—É–∫ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –≠–º–æ–¥–∑–∏/–ö–∞—Ä—Ç–∏–Ω–æ–∫
            Events.on(render, 'afterRender', Game.renderCustomSkins);

            // –•—É–∫ –∫–æ–ª–ª–∏–∑–∏–π (–°–ª–∏—è–Ω–∏–µ)
            Events.on(engine, 'collisionStart', Game.handleCollisions);

            runner = Runner.create();
            Runner.run(runner, engine);
            Render.run(render);

            // –í–≤–æ–¥ (–ú—ã—à—å/–¢–∞—á)
            window.addEventListener('mousedown', Game.handleInput);
            window.addEventListener('touchstart', Game.handleInput);
            window.addEventListener('mousemove', Game.moveBall);
            window.addEventListener('touchmove', Game.moveBall);
        },

        spawnNext: () => {
            if(!gameActive) return;
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —à–∞—Ä
            nextBallIndex = Math.floor(Math.random() * 3); // –¢–æ–ª—å–∫–æ –º–µ–ª–∫–∏–µ
            const size = BALL_SIZES[nextBallIndex];
            const skinData = SKINS_DB[currentSkin];
            const levelData = skinData.levels[nextBallIndex];

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –ø—Ä–µ–≤—å—é
            document.getElementById('next-ball-preview').innerText = levelData.label;

            // –°–æ–∑–¥–∞–µ–º —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ —Ç–µ–ª–æ (–Ω–æ –ø–æ–∫–∞ —Å—Ç–∞—Ç–∏—á–Ω–æ–µ)
            currentBall = Matter.Bodies.circle(W/2, 60, size, {
                isStatic: true,
                label: nextBallIndex,
                render: { fillStyle: levelData.color }
            });
            Matter.World.add(engine.world, currentBall);
            canDrop = true;
        },

        moveBall: (e) => {
            if(canDrop && currentBall && !isBuffActive) {
                let x = (e.touches ? e.touches[0].clientX : e.clientX);
                x = Math.max(30, Math.min(x, W - 30));
                Matter.Body.setPosition(currentBall, { x: x, y: 60 });
            }
        },

        handleInput: (e) => {
            if(!gameActive) return;

            // –†–ï–ñ–ò–ú –ë–ê–§–§–ê (–£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ)
            if(isBuffActive) {
                const x = (e.touches ? e.touches[0].clientX : e.clientX);
                const y = (e.touches ? e.touches[0].clientY : e.clientY);

                // –ò—â–µ–º —Ç–µ–ª–æ –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
                const bodies = Matter.Composite.allBodies(engine.world);
                const clickedBody = bodies.find(b => Matter.Bounds.contains(b.bounds, {x:x, y:y}) && !b.isStatic);

                if(clickedBody) {
                    Game.createExplosionEffect(clickedBody.position.x, clickedBody.position.y);
                    Matter.World.remove(engine.world, clickedBody);
                    isBuffActive = false;
                    document.getElementById('buff-btn').classList.remove('active');
                    document.body.classList.remove('destroy-cursor');
                    document.getElementById('buff-btn').innerText = `üî® –£–ù–ò–ß–¢–û–ñ–ò–¢–¨`;
                }
                return;
            }

            // –†–ï–ñ–ò–ú –°–ë–†–û–°–ê
            if(canDrop && currentBall) {
                let x = (e.touches ? e.touches[0].clientX : e.clientX);
                x = Math.max(30, Math.min(x, W - 30));
                Matter.Body.setPosition(currentBall, { x: x, y: 60 });
                Matter.Body.setStatic(currentBall, false);
                currentBall.restitution = 0.4;
                canDrop = false;
                currentBall = null;
                setTimeout(Game.spawnNext, 800);
            }
        },

        handleCollisions: (event) => {
            const pairs = event.pairs;
            pairs.forEach(pair => {
                const { bodyA, bodyB } = pair;
                if(bodyA.label === bodyB.label && Number.isInteger(bodyA.label)) {
                    const idx = bodyA.label;
                    if(idx < BALL_SIZES.length - 1) {
                        const newIdx = idx + 1;
                        const midX = (bodyA.position.x + bodyB.position.x)/2;
                        const midY = (bodyA.position.y + bodyB.position.y)/2;

                        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ
                        Matter.World.remove(engine.world, [bodyA, bodyB]);

                        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
                        const skin = SKINS_DB[currentSkin];
                        const level = skin.levels[newIdx];
                        const size = BALL_SIZES[newIdx];

                        const newBody = Matter.Bodies.circle(midX, midY, size, {
                            label: newIdx,
                            restitution: 0.3,
                            render: { fillStyle: level.color }
                        });
                        Matter.World.add(engine.world, newBody);

                        // –≠—Ñ—Ñ–µ–∫—Ç—ã
                        score += level.score;
                        Game.updateUI();
                        Game.playSound('merge');
                    }
                }
            });
        },

        activateBuff: () => {
            if(score - lastBuffScore >= 2500 && !isBuffActive) {
                isBuffActive = true;
                lastBuffScore = score; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –±–∞—Ñ—Ñ–∞ (–Ω–æ –Ω–µ –æ–±—â–∏–π —Å—á–µ—Ç)
                document.body.classList.add('destroy-cursor');
                document.getElementById('buff-btn').classList.remove('active');
                document.getElementById('buff-btn').innerText = "‚ùå –í–´–ë–ï–†–ò –¶–ï–õ–¨";
            }
        },

        updateUI: () => {
            document.getElementById('score-val').innerText = score;

            const btn = document.getElementById('buff-btn');
            const progress = score - lastBuffScore;

            if(progress >= 2500) {
                if(!btn.classList.contains('active') && !isBuffActive) {
                    btn.classList.add('active');
                    btn.innerText = "üî• –ì–û–¢–û–í–û (–ñ–ú–ò)";
                }
            } else {
                btn.innerText = `üî® ${progress}/2500`;
            }
        },

        renderCustomSkins: () => {
            const ctx = render.context;
            const bodies = Matter.Composite.allBodies(engine.world);
            const skin = SKINS_DB[currentSkin];

            ctx.font = "bold 20px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            bodies.forEach(body => {
                if(Number.isInteger(body.label)) {
                    const lvlData = skin.levels[body.label];
                    const size = BALL_SIZES[body.label];

                    if(skin.type === 'image' && lvlData.file) {
                        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ö–ê–†–¢–ò–ù–ö–ò
                        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–∞–¥–æ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∏—Ç—å. 
                        // –ó–¥–µ—Å—å —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞:
                        const img = new Image();
                        img.src = skin.path + lvlData.file;
                        // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –≠—Ç–æ –ø–ª–æ—Ö–æ–π —Å–ø–æ—Å–æ–± (—Å–æ–∑–¥–∞–≤–∞—Ç—å Image –≤ render loop).
                        // –ù–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ —Å–æ–π–¥–µ—Ç. –í –ø—Ä–æ–¥–µ –Ω—É–∂–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ.
                        if(img.complete) {
                            ctx.drawImage(img, body.position.x - size, body.position.y - size, size*2, size*2);
                        } else {
                            // –ü–æ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å - —Ä–∏—Å—É–µ–º —ç–º–æ–¥–∑–∏
                            ctx.font = `${size*1.2}px Arial`;
                            ctx.fillText(lvlData.label, body.position.x, body.position.y);
                        }
                    } else {
                        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≠–ú–û–î–ó–ò
                        ctx.font = `${size*1.2}px Arial`;
                        ctx.fillText(lvlData.label, body.position.x, body.position.y + (size*0.1));
                    }
                }
            });

            // –õ–∏–Ω–∏—è —Å–º–µ—Ä—Ç–∏
            ctx.beginPath();
            ctx.moveTo(0, 150);
            ctx.lineTo(W, 150);
            ctx.strokeStyle = 'rgba(255,50,50,0.4)';
            ctx.setLineDash([10, 15]);
            ctx.stroke();

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–≥—Ä—ã—à–∞
            Game.checkGameOver(bodies);
        },

        checkGameOver: (bodies) => {
            if(!gameActive) return;
            for(let b of bodies) {
                if(!b.isStatic && b.position.y < 150 && Math.abs(b.velocity.y) < 0.1) {
                    Menu.showGameOver();
                    break;
                }
            }
        },

        playSound: (type) => {
            // –ü—Ä–æ—Å—Ç–µ–π—à–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–≤—É–∫–∞ (–ø–∏—Å–∫), –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–∞–π–ª–∞
            if(SOUNDS_CFG[type]) {
               const audio = new Audio(SOUNDS_CFG[type]);
               audio.play().catch(e=>{});
            } else {
                // –°–∏–Ω—Ç–µ–∑–∏—Ä—É–µ–º –∑–≤—É–∫, —á—Ç–æ–±—ã –±—ã–ª–æ —Å–ª—ã—à–Ω–æ —Ö–æ—Ç—å —á—Ç–æ-—Ç–æ
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.frequency.value = 300 + (Math.random()*200);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            }
        },

        createExplosionEffect: (x, y) => {
            // –¢—É—Ç –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —á–∞—Å—Ç–∏—Ü—ã
            console.log("BOOM at", x, y);
        }
    };

    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª
    document.addEventListener('touchmove', function(e) { e.preventDefault(); }, { passive: false });
</script>
</body>
</html>