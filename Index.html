<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Rings: Chaos Physics</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

        body {
            margin: 0; background-color: #050505; color: #fff; overflow: hidden;
            font-family: 'Orbitron', sans-serif; touch-action: none;
        }
        canvas { display: block; width: 100vw; height: 100vh; }

        /* ИНТЕРФЕЙС */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 10;
        }

        #settings-panel {
            background: rgba(20, 20, 30, 0.9);
            border: 1px solid #00ffff;
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.15);
            padding: 20px; border-radius: 12px; pointer-events: auto;
            width: 340px; max-height: 90vh; overflow-y: auto;
            display: flex; flex-direction: column; gap: 10px;
        }
        #settings-panel::-webkit-scrollbar { width: 4px; }
        #settings-panel::-webkit-scrollbar-thumb { background: #00ffff; }

        h2 { margin: 0 0 10px 0; color: #00ffff; text-align: center; font-size: 16px; letter-spacing: 2px; }

        .control-group { display: flex; flex-direction: column; gap: 4px; padding-bottom: 5px; border-bottom: 1px solid #333; }
        .control-group:last-child { border: none; }

        label { font-size: 11px; color: #aaa; display: flex; justify-content: space-between; text-transform: uppercase; }
        .val { color: #fff; font-weight: bold; }

        input[type=range] { width: 100%; accent-color: #00ffff; cursor: pointer; height: 4px; margin-top: 5px; }

        .btn {
            background: #00ffff; color: #000; border: none; padding: 12px;
            font-weight: 800; font-family: inherit; cursor: pointer;
            border-radius: 2px; text-transform: uppercase; margin-top: 10px;
            box-shadow: 0 0 15px rgba(0,255,255,0.4);
            transition: 0.2s;
        }
        .btn:hover { background: #fff; box-shadow: 0 0 25px rgba(0,255,255,0.8); }
        .btn:active { transform: scale(0.98); }
        .btn-red { background: #ff4444; box-shadow: 0 0 15px rgba(255,68,68,0.4); color: white;}
        .btn-red:hover { background: #ff6666; }

        #btn-menu {
            position: absolute; top: 15px; right: 15px;
            width: 40px; height: 40px;
            background: rgba(0,0,0,0.5); border: 1px solid #00ffff;
            color: #00ffff; border-radius: 50%; cursor: pointer; pointer-events: auto;
            display: none; align-items: center; justify-content: center;
            font-size: 20px; z-index: 5; transition: 0.3s;
        }
        #btn-menu:hover { background: #00ffff; color: #000; }

        #hud {
            position: absolute; top: 30px; width: 100%; text-align: center; pointer-events: none;
        }
        .hud-val { font-size: 40px; font-weight: 800; color: #fff; text-shadow: 0 0 20px #00ffff; }
        .hud-label { font-size: 12px; color: #888; letter-spacing: 3px; }
    </style>
</head>
<body>

    <div id="hud">
        <div class="hud-label">TARGETS LEFT</div>
        <div class="hud-val" id="rings-left">0</div>
    </div>

    <button id="btn-menu" onclick="Game.pause()">⚙️</button>

    <div id="ui-layer">
        <div id="settings-panel">
            <h2>ПАРАМЕТРЫ СИМУЛЯЦИИ</h2>

            <div class="control-group">
                <label>Количество колец: <span id="v-count" class="val">12</span></label>
                <input type="range" id="i-count" min="3" max="50" value="12" oninput="UI.upd('count', this.value)">
            </div>

            <div class="control-group">
                <label>Расстояние (Gap): <span id="v-gap" class="val">30</span></label>
                <input type="range" id="i-gap" min="15" max="80" value="30" oninput="UI.upd('gap', this.value)">
            </div>

            <div class="control-group">
                <label>Толщина линий: <span id="v-thick" class="val">4</span></label>
                <input type="range" id="i-thick" min="1" max="20" value="4" oninput="UI.upd('thick', this.value)">
            </div>

            <div class="control-group">
                <label>Размер дырки (°): <span id="v-hole" class="val">50</span></label>
                <input type="range" id="i-hole" min="20" max="150" value="50" oninput="UI.upd('hole', this.value)">
            </div>

            <div class="control-group">
                <label>Базовая скорость: <span id="v-rot" class="val">0.015</span></label>
                <input type="range" id="i-rot" min="0" max="0.1" step="0.001" value="0.015" oninput="UI.upd('rot', this.value)">
            </div>

            <div class="control-group">
                <label>Разница скоростей: <span id="v-step" class="val">0.002</span></label>
                <input type="range" id="i-step" min="0" max="0.01" step="0.0001" value="0.002" oninput="UI.upd('step', this.value)">
            </div>

            <div class="control-group">
                <label style="color:#00ffff">Хаос отскока: <span id="v-chaos" class="val">0.3</span></label>
                <input type="range" id="i-chaos" min="0" max="1.0" step="0.05" value="0.3" oninput="UI.upd('chaos', this.value)">
                <div style="font-size:9px; color:#666; margin-top:2px;">Влияет на случайность угла и подкрутку</div>
            </div>

            <div class="control-group">
                <label>Скорость мяча: <span id="v-speed" class="val">6</span></label>
                <input type="range" id="i-speed" min="3" max="25" step="0.5" value="6" oninput="UI.upd('speed', this.value)">
            </div>

            <div class="control-group">
                <label>Размер мяча: <span id="v-size" class="val">8</span></label>
                <input type="range" id="i-size" min="3" max="25" value="8" oninput="UI.upd('size', this.value)">
            </div>

            <button class="btn" onclick="Game.start()">ЗАПУСК</button>
            <button class="btn btn-red" id="btn-restart" onclick="Game.restart()" style="display:none">РЕСТАРТ</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    const AudioSys = {
        ctx: null,
        init() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
        play(freq, type, vol, decay) {
            if(!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            gain.gain.setValueAtTime(vol, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + decay);
            osc.connect(gain); gain.connect(this.ctx.destination);
            osc.start(); osc.stop(this.ctx.currentTime + decay);
        },
        hit() { this.play(100 + Math.random()*50, 'square', 0.1, 0.1); },
        pop() { this.play(400 + Math.random()*400, 'sine', 0.15, 0.3); },
        win() { this.play(600, 'triangle', 0.2, 0.6); }
    };

    const CFG = {
        count: 12, gap: 30, thick: 4,
        rotBase: 0.015, rotStep: 0.002,
        holeDeg: 50, speed: 6, ballR: 8,
        chaos: 0.3 // Новый параметр
    };

    class Ball {
        constructor() {
            this.x = 0; this.y = 0;
            this.vx = 0; this.vy = 0;
            this.trail = [];
        }

        reset() {
            this.x = 0; this.y = 0;
            const a = Math.random() * Math.PI * 2;
            this.vx = Math.cos(a) * CFG.speed;
            this.vy = Math.sin(a) * CFG.speed;
            this.trail = [];
        }

        update() {
            this.prevDist = Math.sqrt(this.x*this.x + this.y*this.y);
            this.x += this.vx;
            this.y += this.vy;
            this.dist = Math.sqrt(this.x*this.x + this.y*this.y);
            this.angle = Math.atan2(this.y, this.x);
            if (this.angle < 0) this.angle += Math.PI * 2;

            this.trail.push({x: this.x, y: this.y});
            if(this.trail.length > 25) this.trail.shift();
        }

        draw(ctx) {
            if(this.trail.length > 1) {
                ctx.beginPath();
                ctx.moveTo(this.trail[0].x, this.trail[0].y);
                for(let p of this.trail) ctx.lineTo(p.x, p.y);
                ctx.strokeStyle = `rgba(0, 255, 255, 0.3)`;
                ctx.lineWidth = CFG.ballR * 0.6;
                ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                ctx.stroke();
            }
            ctx.beginPath();
            ctx.arc(this.x, this.y, CFG.ballR, 0, Math.PI*2);
            ctx.fillStyle = '#fff';
            ctx.shadowColor = '#0ff'; ctx.shadowBlur = 20;
            ctx.fill();
            ctx.shadowBlur = 0;
        }

        // --- УЛУЧШЕННЫЙ ОТСКОК ---
        // nx, ny - нормаль стены
        // wallSpeed - скорость вращения стены (для подкрутки)
        bounce(nx, ny, wallSpeed) {
            // 1. Стандартное отражение
            const dot = this.vx * nx + this.vy * ny;
            let rx = this.vx - 2 * dot * nx;
            let ry = this.vy - 2 * dot * ny;

            // 2. Добавляем "Случайный джиттер" (чтобы не было идеальных петель)
            // Угол отклонения зависит от параметра Chaos
            const noise = (Math.random() - 0.5) * CFG.chaos; 
            const cos = Math.cos(noise);
            const sin = Math.sin(noise);

            // Поворачиваем вектор скорости на случайный угол
            let fx = rx * cos - ry * sin;
            let fy = rx * sin + ry * cos;

            // 3. Добавляем "Эффект трения" от вращения кольца
            // Вектор касательной (перпендикуляр к нормали)
            let tx = -ny; 
            let ty = nx;

            // Сила подкрутки зависит от скорости кольца и параметра Chaos
            let spinForce = wallSpeed * 30 * CFG.chaos; 
            fx += tx * spinForce;
            fy += ty * spinForce;

            // 4. Нормализация (возвращаем идеальную скорость)
            const mag = Math.sqrt(fx*fx + fy*fy);
            this.vx = (fx / mag) * CFG.speed;
            this.vy = (fy / mag) * CFG.speed;

            AudioSys.hit();
        }
    }

    class Ring {
        constructor(idx) {
            this.idx = idx;
            this.active = true;
            this.radius = 50 + (idx * CFG.gap);
            // Чередование и скорость
            let dir = idx % 2 === 0 ? 1 : -1;
            this.rotSpeed = (CFG.rotBase + (idx * CFG.rotStep)) * dir;
            this.angle = Math.random() * Math.PI * 2;
            this.hue = (idx / CFG.count) * 360; 
        }

        update() {
            if(!this.active) return;
            this.angle += this.rotSpeed;
            this.angle %= (Math.PI*2);
            if(this.angle < 0) this.angle += Math.PI*2;
        }

        check(ball) {
            if(!this.active) return;
            const collisionDist = this.radius - CFG.ballR;

            // Если пересекли границу
            if (ball.prevDist < collisionDist && ball.dist >= collisionDist) {

                // Проверка дырки
                const holeRad = (CFG.holeDeg * Math.PI) / 180;
                let startA = this.angle;
                let endA = this.angle + holeRad;

                // Нормализация для проверки
                const norm = a => (a < 0 ? a + Math.PI*2 : a) % (Math.PI*2);
                let bA = norm(ball.angle);
                startA = norm(startA);
                endA = norm(endA);

                let inGap = (startA < endA) 
                    ? (bA >= startA && bA <= endA) 
                    : (bA >= startA || bA <= endA);

                if (inGap) {
                    // ПРОШЕЛ
                    this.active = false;
                    AudioSys.pop();
                    Game.explode(this.radius, this.hue);
                } else {
                    // ОТСКОК
                    let nx = -ball.x / ball.dist;
                    let ny = -ball.y / ball.dist;

                    // Передаем скорость вращения кольца для эффекта подкрутки
                    ball.bounce(nx, ny, this.rotSpeed);

                    // Коррекция позиции (чтобы не застрял)
                    let pushRatio = (collisionDist - 0.5) / ball.dist; 
                    ball.x *= pushRatio;
                    ball.y *= pushRatio;
                }
            }
        }

        draw(ctx) {
            if(!this.active) return;
            const holeRad = (CFG.holeDeg * Math.PI) / 180;
            ctx.beginPath();
            ctx.arc(0, 0, this.radius, this.angle + holeRad, this.angle);
            ctx.strokeStyle = `hsl(${this.hue}, 80%, 60%)`;
            ctx.lineWidth = CFG.thick;
            ctx.lineCap = 'round'; 
            ctx.shadowColor = ctx.strokeStyle; ctx.shadowBlur = 10;
            ctx.stroke(); ctx.shadowBlur = 0;
        }
    }

    let particles = [];
    const Game = {
        canvas: document.getElementById('gameCanvas'),
        ctx: document.getElementById('gameCanvas').getContext('2d'),
        w: 0, h: 0, running: false,
        ball: new Ball(), rings: [],

        init() {
            this.resize();
            window.addEventListener('resize', () => this.resize());
            requestAnimationFrame(() => this.loop());
        },

        resize() {
            this.w = window.innerWidth;
            this.h = window.innerHeight;
            this.canvas.width = this.w; this.canvas.height = this.h;
        },

        start() {
            AudioSys.init();
            this.rings = [];
            for(let i=0; i<CFG.count; i++) this.rings.push(new Ring(i));
            this.ball.reset();
            particles = [];

            document.getElementById('ui-layer').style.display = 'none';
            document.getElementById('btn-restart').style.display = 'block';
            document.getElementById('btn-menu').style.display = 'flex';
            this.running = true;
        },

        pause() {
            this.running = false;
            document.getElementById('ui-layer').style.display = 'flex';
        },

        restart() { this.start(); },

        explode(rad, hue) {
            for(let i=0; i<25; i++) {
                let a = (Math.PI*2/25)*i;
                particles.push({
                    x: Math.cos(a)*rad, y: Math.sin(a)*rad,
                    vx: Math.cos(a)*(1+Math.random()*4), vy: Math.sin(a)*(1+Math.random()*4),
                    life: 1, color: `hsl(${hue}, 100%, 70%)`
                });
            }
        },

        loop() {
            this.ctx.fillStyle = '#050505';
            this.ctx.fillRect(0,0,this.w,this.h);
            const cx = this.w/2, cy = this.h/2;

            if(this.running) {
                this.ball.update();
                let active = 0;
                for(let r of this.rings) {
                    if(r.active) { r.update(); r.check(this.ball); active++; }
                }
                document.getElementById('rings-left').innerText = active;

                // Очистка частиц
                for(let i=particles.length-1; i>=0; i--) {
                    particles[i].x += particles[i].vx;
                    particles[i].y += particles[i].vy;
                    particles[i].life -= 0.03;
                    if(particles[i].life <= 0) particles.splice(i,1);
                }
            }

            this.ctx.translate(cx, cy);
            // Рисуем кольца (с внешних)
            for(let i=this.rings.length-1; i>=0; i--) this.rings[i].draw(this.ctx);

            // Частицы
            for(let p of particles) {
                this.ctx.globalAlpha = p.life;
                this.ctx.fillStyle = p.color;
                this.ctx.beginPath(); this.ctx.arc(p.x, p.y, 3, 0, Math.PI*2); this.ctx.fill();
            }
            this.ctx.globalAlpha = 1;

            this.ball.draw(this.ctx);
            this.ctx.translate(-cx, -cy);

            requestAnimationFrame(() => this.loop());
        }
    };

    const UI = {
        upd(id, val) {
            document.getElementById('v-'+id).innerText = val;
            val = Number(val);
            if(id === 'count') CFG.count = val;
            if(id === 'gap') CFG.gap = val;
            if(id === 'thick') CFG.thick = val;
            if(id === 'rot') CFG.rotBase = val;
            if(id === 'step') CFG.rotStep = val;
            if(id === 'hole') CFG.holeDeg = val;
            if(id === 'speed') CFG.speed = val;
            if(id === 'size') CFG.ballR = val;
            if(id === 'chaos') CFG.chaos = val;
        }
    };

    Game.init();
</script>
</body>
</html>