<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ETERNA-QUEST: Fixed</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            background-color: #000;
            overflow: hidden;
            font-family: 'Press Start 2P', monospace;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background: #111;
        }

        canvas {
            display: block;
            image-rendering: pixelated;
        }

        /* –ò–ù–¢–ï–†–§–ï–ô–° */
        .ui-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        /* HUD */
        .hud-panel {
            display: flex;
            padding: 10px;
            gap: 10px;
        }

        .portrait {
            width: 48px; height: 48px;
            background: #3e2723;
            border: 2px solid #ffd700;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
        }

        .bars { display: flex; flex-direction: column; gap: 4px; flex-grow: 1; max-width: 200px; }
        .bar-bg { width: 100%; height: 12px; background: #222; border: 2px solid #000; }
        .bar-fill { height: 100%; transition: width 0.1s; }
        .hp { background: #d32f2f; }

        .stats { color: #ffd700; font-size: 10px; margin-top: 5px; text-shadow: 1px 1px 0 #000; }

        /* –ú–ï–ù–Æ */
        .menu-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 20;
            pointer-events: auto;
        }

        .menu-box {
            background: #2d2d2d;
            border: 4px solid #ffd700;
            padding: 20px;
            text-align: center;
            color: white;
            width: 300px;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }

        .btn {
            background: #5d4037;
            color: #ffd700;
            border: 2px solid #3e2723;
            padding: 15px;
            width: 100%;
            margin-top: 10px;
            font-family: inherit;
            font-size: 14px;
            text-transform: uppercase;
            cursor: pointer;
        }
        .btn:active { transform: scale(0.98); background: #4e342e; }

        /* –°–ï–ù–°–û–†–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï */
        #mobile-controls {
            position: absolute;
            bottom: 20px; left: 0;
            width: 100%;
            height: 140px;
            padding: 0 20px;
            box-sizing: border-box;
            display: none; /* JS –≤–∫–ª—é—á–∏—Ç */
            justify-content: space-between;
            align-items: flex-end;
            z-index: 15;
            pointer-events: none; /* –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–ª–∏–∫–∏ —Å–∫–≤–æ–∑—å –ø—É—Å—Ç–æ—Ç—É */
        }

        .control-group { pointer-events: auto; display: flex; gap: 15px; }

        .t-btn {
            width: 70px; height: 70px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px;
            color: rgba(255,255,255,0.7);
            user-select: none;
        }
        .t-btn:active { background: rgba(255,215,0,0.3); border-color: #ffd700; color: #fff; }
        .btn-atk { width: 80px; height: 80px; border-radius: 15px; background: rgba(200,50,50,0.2); border-color: #ef5350; }

    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div class="ui-layer">
        <div class="hud-panel">
            <div class="portrait">üõ°Ô∏è</div>
            <div class="bars">
                <div class="bar-bg"><div id="hp-bar" class="bar-fill hp" style="width: 100%;"></div></div>
                <div class="stats">
                    LVL <span id="ui-lvl">1</span> | üí∞ <span id="ui-gold">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
    <div id="main-menu" class="menu-overlay">
        <div class="menu-box">
            <h1 style="color:#ffd700; margin:0 0 10px 0;">ETERNA QUEST</h1>
            <p style="font-size:10px; color:#aaa;">PIXEL DUNGEON CRAWLER</p>
            <button class="btn" onclick="Game.startNewGame()">–ù–û–í–ê–Ø –ò–ì–†–ê</button>
        </div>
    </div>

    <!-- –ú–ï–ù–Æ –ü–†–ò–í–ê–õ–ê -->
    <div id="rest-menu" class="menu-overlay" style="display:none;">
        <div class="menu-box">
            <h2>–£–†–û–í–ï–ù–¨ –ó–ê–ß–ò–©–ï–ù</h2>
            <p>–ó–æ–ª–æ—Ç–æ: <span id="rest-gold" style="color:#ffd700">0</span></p>
            <hr style="border-color:#444; margin: 15px 0;">
            <button class="btn" onclick="Game.buyHeal()">–õ–ï–ß–ï–ù–ò–ï (50$)</button>
            <button class="btn" onclick="Game.buyDmg()">–£–†–û–ù + (100$)</button>
            <button class="btn" style="background:#2e7d32; color:#fff;" onclick="Game.nextLevel()">–°–õ–ï–î–£–Æ–©–ò–ô –£–†–û–í–ï–ù–¨</button>
        </div>
    </div>

    <!-- –ú–ï–ù–Æ –°–ú–ï–†–¢–ò -->
    <div id="death-menu" class="menu-overlay" style="display:none;">
        <div class="menu-box" style="border-color:#d32f2f;">
            <h2 style="color:#d32f2f">–í–´ –ü–û–ì–ò–ë–õ–ò</h2>
            <button class="btn" onclick="location.reload()">–í –ú–ï–ù–Æ</button>
        </div>
    </div>

    <!-- –°–ï–ù–°–û–†–´ -->
    <div id="mobile-controls">
        <div class="control-group">
            <div class="t-btn" id="btn-l">‚¨ÖÔ∏è</div>
            <div class="t-btn" id="btn-r">‚û°Ô∏è</div>
        </div>
        <div class="control-group">
            <div class="t-btn btn-atk" id="btn-atk">‚öîÔ∏è</div>
            <div class="t-btn" id="btn-j">‚¨ÜÔ∏è</div>
        </div>
    </div>
</div>

<script>
/* --- –î–í–ò–ñ–û–ö --- */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏
const TILE = 40;
const GRAVITY = 0.8;
const SPEED = 6;
const JUMP = 15;

// –°–æ—Å—Ç–æ—è–Ω–∏–µ
let W, H;
const keys = { l: false, r: false, u: false, atk: false };

// --- –ì–†–ê–§–ò–ö–ê (–ü–†–û–ì–†–ê–ú–ú–ù–´–ï –°–ü–†–ê–ô–¢–´) ---
const Art = {
    rect: (x, y, w, h, c) => { ctx.fillStyle = c; ctx.fillRect(Math.floor(x), Math.floor(y), w, h); },

    // –°—Ç–µ–Ω–∞
    wall: (x, y) => {
        Art.rect(x, y, TILE, TILE, '#4e342e'); // –¢–µ–º–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π
        Art.rect(x, y, TILE, 2, '#6d4c41'); // –°–≤–µ—Ç–ª—ã–π –≤–µ—Ä—Ö
        Art.rect(x+10, y, 2, TILE, '#3e2723'); // –®–æ–≤
        Art.rect(x, y+20, TILE, 2, '#3e2723'); // –®–æ–≤ –≥–æ—Ä.
        // –î–µ–∫–æ—Ä
        if ((x+y)%3 === 0) Art.rect(x+5, y+5, 4, 4, '#5d4037');
    },

    // –†—ã—Ü–∞—Ä—å
    player: (x, y, dir, isAtk) => {
        const c = '#90a4ae'; // –ë—Ä–æ–Ω—è
        const c2 = '#1976d2'; // –¢–∫–∞–Ω—å

        // –¢–µ–ª–æ
        Art.rect(x+8, y+10, 24, 20, c);
        Art.rect(x+12, y+14, 16, 12, c2); // –ù–∞–≥—Ä—É–¥–Ω–∏–∫

        // –ì–æ–ª–æ–≤–∞
        Art.rect(x+10, y, 20, 10, c);
        Art.rect(x+20 + (dir*4), y+2, 6, 2, '#000'); // –ì–ª–∞–∑–∞

        // –ù–æ–≥–∏
        Art.rect(x+10, y+30, 8, 10, '#37474f');
        Art.rect(x+22, y+30, 8, 10, '#37474f');

        // –û—Ä—É–∂–∏–µ
        if (isAtk) {
            // –£–¥–∞—Ä
            ctx.fillStyle = '#fff';
            let sx = dir===1 ? x+30 : x-30;
            ctx.beginPath();
            ctx.arc(x+20, y+20, 35, 0, Math.PI*2);
            ctx.globalAlpha = 0.5;
            ctx.fill();
            ctx.globalAlpha = 1.0;
            Art.rect(sx, y+15, 30, 6, '#fff'); // –ú–µ—á
        } else {
            // –í —Ä—É–∫–µ
            let sx = dir===1 ? x+26 : x-6;
            Art.rect(sx, y+12, 4, 16, '#cfd8dc');
        }
    },

    // –í—Ä–∞–≥
    enemy: (x, y, type, dir) => {
        if(type === 1) { // –°–ª–∏–∑–µ–Ω—å
            Art.rect(x+2, y+15, 36, 25, '#76ff03');
            Art.rect(x+8 + (dir*4), y+20, 6, 6, '#000');
            Art.rect(x+20 + (dir*4), y+20, 6, 6, '#000');
        } else { // –°–∫–µ–ª–µ—Ç
            Art.rect(x+10, y+5, 20, 35, '#eee');
            Art.rect(x+14 + (dir*2), y+10, 4, 4, '#000');
            Art.rect(x+22 + (dir*2), y+10, 4, 4, '#000');
            // –ú–µ—á —Å–∫–µ–ª–µ—Ç–∞
            Art.rect(x + (dir===1?25:-5), y+20, 20, 4, '#bdbdbd');
        }
    },

    door: (x, y) => {
        Art.rect(x, y, 40, 60, '#000');
        Art.rect(x-4, y, 4, 60, '#5d4037'); // –†–∞–º–∫–∞
        Art.rect(x+40, y, 4, 60, '#5d4037');
        Art.rect(x+5, y+5, 30, 50, '#7b1fa2'); // –ü–æ—Ä—Ç–∞–ª
    }
};

/* --- –ò–ì–†–ê --- */
const Game = {
    running: false,
    level: 1,
    map: [],
    mapW: 0, mapH: 15,
    camX: 0,

    entities: [],

    player: { x: 100, y: 100, w: 30, h: 40, vx: 0, vy: 0, hp: 100, maxHp: 100, gold: 0, dmg: 10, dir: 1, atkCd: 0, iFrame: 0 },
    door: null,

    // –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–π –∏–≥—Ä—ã
    startNewGame: function() {
        this.player.hp = 100;
        this.player.gold = 0;
        this.level = 1;
        this.player.dmg = 10;
        this.loadLevel();
    },

    nextLevel: function() {
        this.level++;
        this.loadLevel();
    },

    loadLevel: function() {
        // –°–±—Ä–æ—Å UI
        document.querySelectorAll('.menu-overlay').forEach(e => e.style.display = 'none');
        this.resize();

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
        this.genMap();
        this.running = true;
        this.loop();
    },

    resize: function() {
        W = window.innerWidth;
        H = window.innerHeight;
        canvas.width = W;
        canvas.height = H;
        ctx.imageSmoothingEnabled = false;
    },

    genMap: function() {
        this.map = [];
        this.entities = [];
        this.mapW = 40 + (this.level * 5); // –î–ª–∏–Ω–∞ –∫–∞—Ä—Ç—ã

        // 1. –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—É—Å—Ç–æ—Ç–æ–π
        for(let y=0; y<this.mapH; y++) {
            this.map[y] = new Array(this.mapW).fill(0);
        }

        // 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–´–ô –ø–æ–ª
        const groundY = 10;
        for(let x=0; x<this.mapW; x++) {
            // –ì—Ä–∞–Ω–∏—Ü—ã —É—Ä–æ–≤–Ω—è
            if (x === 0 || x === this.mapW - 1) {
                for(let y=0; y<this.mapH; y++) this.map[y][x] = 1; // –°—Ç–µ–Ω—ã
            } 
            // –ü–æ–ª (—Å —è–º–∞–º–∏, –Ω–æ –Ω–µ –≤ –Ω–∞—á–∞–ª–µ)
            else if (x > 10 && x < this.mapW - 10 && Math.random() < 0.1) {
                // –Ø–º–∞ - –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–∏—Å—É–µ–º
            } else {
                this.map[groundY][x] = 1; // –ü–æ–ª
                // –ó–µ–º–ª—è –ø–æ–¥ –ø–æ–ª–æ–º
                for(let y=groundY+1; y<this.mapH; y++) this.map[y][x] = 1;

                // –í—Ä–∞–≥–∏
                if (x > 10 && Math.random() < 0.1) {
                    this.spawnEnemy(x*TILE, (groundY-1)*TILE);
                }

                // –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã
                if (Math.random() < 0.3) {
                    let py = groundY - 3;
                    this.map[py][x] = 1;
                    if(Math.random() < 0.2) this.spawnEnemy(x*TILE, (py-1)*TILE);
                }
            }
        }

        // 3. –°–ø–∞–≤–Ω –∏–≥—Ä–æ–∫–∞ (–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –º–µ—Å—Ç–æ)
        this.player.x = TILE * 3;
        this.player.y = TILE * 5; // –ü–∞–¥–∞–µ—Ç —Å–≤–µ—Ä—Ö—É
        this.player.vx = 0;
        this.player.vy = 0;

        // 4. –î–≤–µ—Ä—å (–≤ –∫–æ–Ω—Ü–µ)
        // –ò—â–µ–º —Ç–≤–µ—Ä–¥—É—é –∑–µ–º–ª—é –≤ –∫–æ–Ω—Ü–µ –∫–∞—Ä—Ç—ã
        let doorX = this.mapW - 3;
        this.map[groundY][doorX] = 1; // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø–æ–ª –ø–æ–¥ –¥–≤–µ—Ä—å—é
        this.map[groundY][doorX-1] = 1;
        this.door = { x: doorX*TILE, y: (groundY-1.5)*TILE, w:40, h:60 };
    },

    spawnEnemy: function(x, y) {
        let type = (Math.random()>0.5 && this.level>1) ? 2 : 1;
        this.entities.push({
            x:x, y:y, w:30, h:30, 
            type:type, hp: 20 + (this.level*5), 
            vx:1, vy:0, dir:1
        });
    },

    update: function() {
        if(!this.running) return;
        const p = this.player;

        // --- –ò–ì–†–û–ö ---
        if(keys.l) { p.vx = -SPEED; p.dir = -1; }
        else if(keys.r) { p.vx = SPEED; p.dir = 1; }
        else p.vx *= 0.5;

        // –ü—Ä—ã–∂–æ–∫
        if(keys.u && p.grounded) { p.vy = -JUMP; p.grounded = false; }

        // –§–∏–∑–∏–∫–∞
        p.vy += GRAVITY;
        p.x += p.vx;
        this.collide(p, 'x');
        p.y += p.vy;
        this.collide(p, 'y');

        // –°–º–µ—Ä—Ç—å –æ—Ç –ø–∞–¥–µ–Ω–∏—è
        if(p.y > this.mapH * TILE + 200) this.gameOver();

        // –ê—Ç–∞–∫–∞
        if(p.atkCd > 0) p.atkCd--;
        if(keys.atk && p.atkCd === 0) {
            p.atkCd = 20;
            // –•–∏—Ç–±–æ–∫—Å —É–¥–∞—Ä–∞
            let hitX = p.dir === 1 ? p.x + p.w : p.x - 40;
            let hitRect = { x: hitX, y: p.y, w: 40, h: p.h };

            this.entities.forEach(e => {
                if(this.rectIntersect(hitRect, e)) {
                    e.hp -= p.dmg;
                    e.vx = p.dir * 8; // –û—Ç–±—Ä–æ—Å
                    e.vy = -5;
                    e.grounded = false;
                    if(e.hp <= 0) {
                        e.dead = true;
                        p.gold += 10;
                    }
                }
            });
        }

        // --- –í–†–ê–ì–ò ---
        this.entities.forEach(e => {
            e.vy += GRAVITY;

            // –ü—Ä–æ—Å—Ç–æ–π –ò–ò
            if(e.grounded) {
                if(e.type === 1) { // –°–ª–∏–∑–µ–Ω—å (—Ç—É–ø–æ–π)
                   if(Math.random()<0.02) e.dir *= -1;
                } else { // –°–∫–µ–ª–µ—Ç (–∏–¥–µ—Ç –∫ –∏–≥—Ä–æ–∫—É)
                    if(Math.abs(p.x - e.x) < 200) {
                        e.dir = p.x > e.x ? 1 : -1;
                    }
                }
                e.vx = e.dir * (e.type===1 ? 2 : 3);
            }

            e.x += e.vx; this.collide(e, 'x');
            e.y += e.vy; this.collide(e, 'y');

            // –£—Ä–æ–Ω –∏–≥—Ä–æ–∫—É
            if(this.rectIntersect(p, e) && !e.dead && p.iFrame <= 0) {
                p.hp -= 20;
                p.iFrame = 60;
                p.vy = -8;
                p.vx = -p.dir * 10;
                if(p.hp <= 0) this.gameOver();
            }
        });
        this.entities = this.entities.filter(e => !e.dead);
        if(p.iFrame > 0) p.iFrame--;

        // --- –ö–ê–ú–ï–†–ê ---
        let targetCam = p.x - W/2;
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É, —á—Ç–æ–±—ã –Ω–µ –≤–∏–¥–µ—Ç—å –ø—É—Å—Ç–æ—Ç—É
        targetCam = Math.max(0, Math.min(targetCam, this.mapW * TILE - W));
        this.camX += (targetCam - this.camX) * 0.1;

        // --- –í–´–•–û–î ---
        if(this.rectIntersect(p, this.door)) {
            this.levelComplete();
        }

        // UI
        document.getElementById('hp-bar').style.width = (p.hp / p.maxHp * 100) + '%';
        document.getElementById('ui-gold').innerText = p.gold;
        document.getElementById('ui-lvl').innerText = this.level;
    },

    draw: function() {
        // –§–æ–Ω (–°–µ—Ä—ã–π —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫)
        ctx.fillStyle = '#212121'; 
        ctx.fillRect(0, 0, W, H);

        ctx.save();
        ctx.translate(-Math.floor(this.camX), 0);

        // –†–∏—Å—É–µ–º –∫–∞—Ä—Ç—É (—Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—É—é —á–∞—Å—Ç—å)
        let startCol = Math.floor(this.camX / TILE);
        let endCol = startCol + (W / TILE) + 2;

        for(let y=0; y<this.mapH; y++) {
            for(let x=startCol; x<endCol; x++) {
                if(this.map[y] && this.map[y][x]) {
                    Art.wall(x*TILE, y*TILE);
                }
            }
        }

        // –î–≤–µ—Ä—å
        Art.door(this.door.x, this.door.y);

        // –í—Ä–∞–≥–∏
        this.entities.forEach(e => Art.enemy(e.x, e.y, e.type, e.dir));

        // –ò–≥—Ä–æ–∫ (–º–∏–≥–∞–Ω–∏–µ –µ—Å–ª–∏ —Ä–∞–Ω–µ–Ω)
        if(Math.floor(this.player.iFrame / 5) % 2 === 0) {
            Art.player(this.player.x, this.player.y, this.player.dir, this.player.atkCd > 10);
        }

        ctx.restore();
    },

    collide: function(obj, axis) {
        let x1 = Math.floor(obj.x / TILE);
        let x2 = Math.floor((obj.x + obj.w - 0.1) / TILE);
        let y1 = Math.floor(obj.y / TILE);
        let y2 = Math.floor((obj.y + obj.h - 0.1) / TILE);

        if (x1 < 0 || x2 >= this.mapW || y1 < 0 || y2 >= this.mapH) return;

        for(let y=y1; y<=y2; y++) {
            for(let x=x1; x<=x2; x++) {
                if(this.map[y] && this.map[y][x] === 1) {
                    if(axis === 'x') {
                        if(obj.vx > 0) obj.x = x*TILE - obj.w;
                        else obj.x = (x+1)*TILE;
                        obj.vx = 0;
                    } else {
                        if(obj.vy > 0) {
                            obj.y = y*TILE - obj.h;
                            obj.grounded = true;
                        } else {
                            obj.y = (y+1)*TILE;
                        }
                        obj.vy = 0;
                    }
                    return;
                }
            }
        }
        if(axis === 'y') obj.grounded = false;
    },

    rectIntersect: function(r1, r2) {
        return !(r2.x > r1.x + r1.w || r2.x + r2.w < r1.x || r2.y > r1.y + r1.h || r2.y + r2.h < r1.y);
    },

    levelComplete: function() {
        this.running = false;
        document.getElementById('rest-menu').style.display = 'flex';
        document.getElementById('rest-gold').innerText = this.player.gold;
    },

    gameOver: function() {
        this.running = false;
        document.getElementById('death-menu').style.display = 'flex';
    },

    loop: function() {
        if(Game.running) {
            Game.update();
            Game.draw();
            requestAnimationFrame(Game.loop);
        }
    },

    // –ú–∞–≥–∞–∑–∏–Ω
    buyHeal: function() {
        if(this.player.gold >= 50) {
            this.player.gold -= 50;
            this.player.hp = Math.min(this.player.hp + 50, this.player.maxHp);
            document.getElementById('rest-gold').innerText = this.player.gold;
        }
    },
    buyDmg: function() {
        if(this.player.gold >= 100) {
            this.player.gold -= 100;
            this.player.dmg += 5;
            document.getElementById('rest-gold').innerText = this.player.gold;
        }
    }
};

// --- –°–û–ë–´–¢–ò–Ø ---
window.addEventListener('resize', Game.resize);

// –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
window.onkeydown = e => {
    if(e.code==='ArrowLeft'||e.code==='KeyA') keys.l=true;
    if(e.code==='ArrowRight'||e.code==='KeyD') keys.r=true;
    if(e.code==='ArrowUp'||e.code==='Space') keys.u=true;
    if(e.code==='KeyZ') keys.atk=true;
};
window.onkeyup = e => {
    if(e.code==='ArrowLeft'||e.code==='KeyA') keys.l=false;
    if(e.code==='ArrowRight'||e.code==='KeyD') keys.r=false;
    if(e.code==='ArrowUp'||e.code==='Space') keys.u=false;
    if(e.code==='KeyZ') keys.atk=false;
};

// –¢–∞—á (–ú–æ–±–∏–ª—å–Ω—ã–π)
if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
    document.getElementById('mobile-controls').style.display = 'flex';
    const bindTouch = (id, key) => {
        let el = document.getElementById(id);
        el.addEventListener('touchstart', (e)=>{ e.preventDefault(); keys[key]=true; });
        el.addEventListener('touchend', (e)=>{ e.preventDefault(); keys[key]=false; });
    };
    bindTouch('btn-l', 'l'); bindTouch('btn-r', 'r');
    bindTouch('btn-j', 'u'); bindTouch('btn-atk', 'atk');
}

</script>
</body>
</html>