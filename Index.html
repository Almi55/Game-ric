<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ETERNA-QUEST: Ruin Legends</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root {
            --gold: #ffb300;
            --dark-ui: #151515;
            --border: #5d4037;
        }

        body {
            margin: 0;
            background-color: #050505;
            overflow: hidden;
            font-family: 'Press Start 2P', cursive;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #111;
        }

        canvas {
            image-rendering: pixelated; /* –ñ–µ—Å—Ç–∫–∏–µ –ø–∏–∫—Å–µ–ª–∏ */
            width: 100%;
            height: 100%;
        }

        /* --- –ò–ù–¢–ï–†–§–ï–ô–° (HUD) --- */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        #hud-top {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            box-sizing: border-box;
            width: 100%;
        }

        .hud-group {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .portrait-box {
            width: 50px;
            height: 50px;
            border: 3px solid var(--gold);
            background: #222;
            image-rendering: pixelated;
        }

        .bars {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 5px;
        }

        .bar-con {
            width: 150px;
            height: 14px;
            background: #333;
            border: 2px solid #000;
            position: relative;
        }

        .bar-fill { height: 100%; width: 100%; transition: width 0.2s; }
        .hp-fill { background: #d32f2f; }
        .mp-fill { background: #1976d2; }

        .level-box {
            border: 3px solid var(--gold);
            background: rgba(0,0,0,0.8);
            padding: 10px;
            text-align: center;
            color: var(--gold);
            font-size: 12px;
            min-width: 80px;
            margin-top: -5px; /* –ß—É—Ç—å –≤—ã—à–µ */
        }

        .minimap-box {
            width: 100px;
            height: 60px;
            border: 3px solid var(--gold);
            background: #000;
            opacity: 0.8;
            margin-right: 10px;
        }

        /* –ü—Ä–∞–≤—ã–µ —Å–ª–æ—Ç—ã */
        #hud-right {
            position: absolute;
            right: 10px;
            top: 100px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .item-slot {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gold);
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 10px;
            position: relative;
        }
        .item-count {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 8px;
        }

        /* –ú–µ–Ω—é (–ü—Ä–∏–≤–∞–ª / –°—Ç–∞—Ä—Ç) */
        .menu-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            z-index: 20;
            display: none;
        }

        .menu-box {
            background: #2e2724;
            border: 4px solid var(--gold);
            padding: 20px;
            text-align: center;
            color: #fff;
            box-shadow: 0 0 20px #000;
            width: 300px;
        }

        .btn {
            background: #5d4037;
            border: 2px solid #8d6e63;
            color: var(--gold);
            padding: 15px;
            width: 100%;
            margin: 10px 0;
            font-family: inherit;
            cursor: pointer;
            text-transform: uppercase;
        }
        .btn:active { background: #3e2723; transform: scale(0.98); }

        /* –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–õ–Ø –¢–ï–õ–ï–§–û–ù–ê */
        #mobile-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            height: 120px;
            padding: 0 30px;
            padding-bottom: env(safe-area-inset-bottom); /* –§–∏–∫—Å –¥–ª—è iPhone/Tablet */
            box-sizing: border-box;
            display: none; /* JS –≤–∫–ª—é—á–∏—Ç */
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: none;
            z-index: 10;
        }

        .ctrl-btn {
            width: 64px;
            height: 64px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            pointer-events: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            backdrop-filter: blur(4px);
            color: #eee;
        }
        .ctrl-btn:active { background: rgba(255,215,0, 0.3); border-color: var(--gold); }

        .d-pad { display: flex; gap: 15px; }
        .actions { display: flex; gap: 15px; }
        .btn-atk { background: rgba(200, 50, 50, 0.2); border-color: #ef5350; width: 70px; height: 70px; }

        /* –ó–æ–ª–æ—Ç–æ —Å—á–µ—Ç—á–∏–∫ */
        #gold-display {
            position: absolute;
            top: 70px;
            left: 10px;
            color: var(--gold);
            font-size: 14px;
            text-shadow: 2px 2px 0 #000;
        }

    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <!-- –ò–ù–¢–ï–†–§–ï–ô–° -->
    <div id="ui-layer" class="ui-layer">

        <div id="hud-top">
            <div class="hud-group">
                <canvas id="portrait-canvas" width="50" height="50" class="portrait-box"></canvas>
                <div class="bars">
                    <div class="bar-con"><div id="hp-bar" class="bar-fill hp-fill"></div></div>
                    <div class="bar-con"><div id="mp-bar" class="bar-fill mp-fill"></div></div>
                </div>
            </div>

            <div class="level-box">
                LEVEL<br><span id="level-display" style="font-size:18px; display:block; margin-top:5px;">1</span>
            </div>

            <canvas id="minimap" width="100" height="60" class="minimap-box"></canvas>
        </div>

        <div id="gold-display">üí∞ 0</div>

        <div id="hud-right">
            <div class="item-slot">‚öîÔ∏è<span class="item-count">1</span></div>
            <div class="item-slot">üõ°Ô∏è<span class="item-count">1</span></div>
            <div class="item-slot">üß™<span class="item-count">3</span></div>
        </div>
    </div>

    <!-- –ú–ï–ù–Æ -->
    <div id="main-menu" class="menu-overlay" style="display: flex;">
        <div class="menu-box">
            <h1 style="color:var(--gold); text-shadow:2px 2px 0 #000;">ETERNA QUEST</h1>
            <p style="font-size:10px; color:#aaa; margin-bottom:20px;">THE ENDLESS RUINS</p>
            <button id="btn-continue" class="btn" style="display:none;" onclick="Game.loadGame()">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
            <button class="btn" onclick="Game.newGame()">–ù–û–í–ê–Ø –ò–ì–†–ê</button>
        </div>
    </div>

    <div id="rest-menu" class="menu-overlay">
        <div class="menu-box">
            <h2>–ü–†–ò–í–ê–õ</h2>
            <p>–£—Ä–æ–≤–µ–Ω—å –∑–∞—á–∏—â–µ–Ω!</p>
            <p style="color:var(--gold)">–í–∞—à–µ –∑–æ–ª–æ—Ç–æ: <span id="rest-gold">0</span></p>
            <hr style="border-color:#555; margin: 15px 0;">
            <button class="btn" onclick="Game.buyHeal()">–õ–ï–ß–ï–ù–ò–ï (50$)</button>
            <button class="btn" onclick="Game.buyUpgrade()">–ó–ê–¢–û–ß–ö–ê (+DMG) (100$)</button>
            <button class="btn" style="background:var(--gold); color:#000;" onclick="Game.nextLevel()">–î–ê–õ–ï–ï ‚û°</button>
        </div>
    </div>

    <div id="game-over" class="menu-overlay">
        <div class="menu-box" style="border-color:#d32f2f;">
            <h2 style="color:#d32f2f;">YOU DIED</h2>
            <p>–í–∞—à–∏ –∫–æ—Å—Ç–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –∑–¥–µ—Å—å...</p>
            <button class="btn" onclick="location.reload()">–í –ú–ï–ù–Æ</button>
        </div>
    </div>

    <!-- –£–ü–†–ê–í–õ–ï–ù–ò–ï -->
    <div id="mobile-controls">
        <div class="d-pad">
            <div class="ctrl-btn" id="btn-left">‚¨ÖÔ∏è</div>
            <div class="ctrl-btn" id="btn-right">‚û°Ô∏è</div>
        </div>
        <div class="actions">
            <div class="ctrl-btn btn-atk" id="btn-attack">‚öîÔ∏è</div>
            <div class="ctrl-btn" id="btn-jump">‚¨ÜÔ∏è</div>
        </div>
    </div>
</div>

<script>
/**
 * ETERNA-QUEST: Engine 2.0
 * Pixel Art Procedural Generation
 */

// --- –ö–û–ù–°–¢–ê–ù–¢–´ ---
const TILE = 40; // –†–∞–∑–º–µ—Ä –∫–ª–µ—Ç–∫–∏ (–∫—Ä—É–ø–Ω–µ–µ –¥–ª—è –ø–∏–∫—Å–µ–ª—å-–∞—Ä—Ç–∞)
const GRAVITY = 0.8;
const JUMP_POWER = 14;
const SPEED = 6;

// –¶–≤–µ—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ø—Ä–∞–π—Ç–æ–≤
const C = {
    brick: '#5d4037', brickD: '#3e2723', brickL: '#8d6e63',
    bg: '#1a1a1d', col: '#121215',
    sky: '#0d0d12',
    gold: '#ffd700',
    blood: '#b71c1c'
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let W, H;

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Canvas
function resize() {
    W = window.innerWidth;
    H = window.innerHeight;
    canvas.width = W;
    canvas.height = H;
    ctx.imageSmoothingEnabled = false;
}
window.addEventListener('resize', resize);
resize();

// --- –£–ü–†–ê–í–õ–ï–ù–ò–ï ---
const keys = { l: false, r: false, u: false, atk: false };
const bind = (k, v) => {
    if(k==='ArrowLeft'||k==='KeyA') keys.l=v;
    if(k==='ArrowRight'||k==='KeyD') keys.r=v;
    if(k==='ArrowUp'||k==='Space') keys.u=v;
    if(k==='KeyZ'||k==='KeyK') keys.atk=v;
};
window.onkeydown = e => bind(e.code, true);
window.onkeyup = e => bind(e.code, false);

// –°–µ–Ω—Å–æ—Ä
if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
    document.getElementById('mobile-controls').style.display = 'flex';
    const tBind = (id, k) => {
        let el = document.getElementById(id);
        el.addEventListener('touchstart', e => { e.preventDefault(); keys[k]=true; });
        el.addEventListener('touchend', e => { e.preventDefault(); keys[k]=false; });
    };
    tBind('btn-left', 'l'); tBind('btn-right', 'r');
    tBind('btn-jump', 'u'); tBind('btn-attack', 'atk');
}

// --- ART GENERATOR (–ü—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–π –ø–∏–∫—Å–µ–ª—å-–∞—Ä—Ç) ---
const Art = {
    // –†–∏—Å—É–µ–º –∫–∏—Ä–ø–∏—á–Ω—É—é —Å—Ç–µ–Ω—É —Å —Ç–µ–∫—Å—Ç—É—Ä–æ–π
    wall: (x, y) => {
        // –ë–∞–∑–∞
        ctx.fillStyle = C.brick;
        ctx.fillRect(x, y, TILE, TILE);

        // –®–≤—ã –∏ –¥–µ—Ç–∞–ª–∏ (–∏–º–∏—Ç–∞—Ü–∏—è 16bit)
        ctx.fillStyle = C.brickD;
        ctx.fillRect(x, y, TILE, 2); // –í–µ—Ä—Ö–Ω—è—è —Ç–µ–Ω—å
        ctx.fillRect(x, y+TILE-2, TILE, 2); // –ù–∏–∂–Ω—è—è —Ç–µ–Ω—å

        // –ö–∏—Ä–ø–∏—á–Ω—ã–π —É–∑–æ—Ä
        ctx.fillRect(x+10, y, 2, TILE); // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —à–æ–≤
        ctx.fillStyle = C.brickL;
        ctx.fillRect(x+2, y+4, 6, 2); // –ë–ª–∏–∫
        ctx.fillRect(x+14, y+10, 4, 2); // –ë–ª–∏–∫

        // –ú–æ—Ö (–∏–Ω–æ–≥–¥–∞)
        if((x+y)%7 === 0) {
            ctx.fillStyle = '#33691e';
            ctx.fillRect(x, y+TILE-6, 8, 6);
        }
    },

    // –§–æ–Ω —Å –∫–æ–ª–æ–Ω–Ω–∞–º–∏ (–ø–∞—Ä–∞–ª–ª–∞–∫—Å —ç—Ñ—Ñ–µ–∫—Ç –¥–µ–ª–∞–µ—Ç—Å—è –≤ —Ä–µ–Ω–¥–µ—Ä–µ)
    column: (x, y, w, h) => {
        ctx.fillStyle = '#261e1b'; // –¢–µ–º–Ω—ã–π –∫–æ–ª–æ–Ω–Ω–∞
        ctx.fillRect(x, y, w, h);
        ctx.fillStyle = '#1a1412';
        ctx.fillRect(x+4, y, 4, h); // –¢–µ–Ω—å
        ctx.fillRect(x+w-8, y, 4, h);

        // –ö–∞–ø–∏—Ç–µ–ª—å
        ctx.fillStyle = '#3e2723';
        ctx.fillRect(x-4, y, w+8, 20);
    },

    // –†—ã—Ü–∞—Ä—å
    knight: (x, y, dir, frame, isAtk) => {
        const f = isAtk ? 0 : Math.floor(frame / 10) % 2; // –ê–Ω–∏–º–∞—Ü–∏—è —Ö–æ—Ç—å–±—ã (2 –∫–∞–¥—Ä–∞)
        const bounce = f * 2;

        ctx.save();
        if (dir === -1) {
            ctx.translate(x + 32, y);
            ctx.scale(-1, 1);
            x = 0; y = 0;
        }

        // –ù–æ–≥–∏
        ctx.fillStyle = '#555';
        ctx.fillRect(x+8, y+24-bounce, 6, 8);
        ctx.fillRect(x+18, y+24+bounce, 6, 8);

        // –¢–µ–ª–æ (–ë—Ä–æ–Ω—è)
        ctx.fillStyle = '#9e9e9e'; // –°–µ—Ä–µ–±—Ä–æ
        ctx.fillRect(x+6, y+10, 20, 16);
        ctx.fillStyle = '#1976d2'; // –ù–∞–≥—Ä—É–¥–Ω–∏–∫ (—Å–∏–Ω–∏–π)
        ctx.fillRect(x+10, y+12, 12, 10);

        // –ì–æ–ª–æ–≤–∞
        ctx.fillStyle = '#bdbdbd'; // –®–ª–µ–º
        ctx.fillRect(x+8, y-2+bounce, 16, 14);
        ctx.fillStyle = '#000'; // –ó–∞–±—Ä–∞–ª–æ
        ctx.fillRect(x+18, y+2+bounce, 6, 2); 

        // –ú–µ—á
        if (isAtk) {
            ctx.fillStyle = '#fff';
            // –í–∑–º–∞—Ö (—ç—Ñ—Ñ–µ–∫—Ç)
            ctx.globalAlpha = 0.5;
            ctx.beginPath();
            ctx.arc(x+25, y+16, 25, -0.5, 1.5);
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 4;
            ctx.stroke();
            ctx.globalAlpha = 1.0;

            // –ö–ª–∏–Ω–æ–∫
            ctx.fillRect(x+20, y+16, 20, 4);
        } else {
            // –í —Ä—É–∫–µ
            ctx.fillStyle = '#ddd';
            ctx.fillRect(x+20, y+14+bounce, 4, 12);
        }

        ctx.restore();
    },

    enemy: (x, y, type, dir, frame) => {
        const bounce = Math.sin(frame/5) * 2;
        if (type === 1) { // –°–∫–µ–ª–µ—Ç
            ctx.fillStyle = '#eee'; // –ö–æ—Å—Ç–∏
            ctx.fillRect(x+10, y+4+bounce, 12, 12); // –ß–µ—Ä–µ–ø
            ctx.fillStyle = '#000';
            ctx.fillRect(x+12+(dir>0?4:0), y+6+bounce, 2, 2); // –ì–ª–∞–∑

            ctx.fillStyle = '#ddd'; 
            ctx.fillRect(x+12, y+16, 8, 10); // –†–µ–±—Ä–∞
            ctx.fillRect(x+8, y+16, 2, 8); // –†—É–∫–∞ –õ
            ctx.fillRect(x+22, y+16, 2, 8); // –†—É–∫–∞ –ü

            // –ú–µ—á
            ctx.fillStyle = '#ccc';
            let sx = dir > 0 ? x+24 : x-8;
            ctx.fillRect(sx, y+18+bounce, 16, 3);

        } else if (type === 2) { // –°–ª–∏–∑–µ–Ω—å
            const squash = Math.abs(Math.sin(frame/10)) * 5;
            ctx.fillStyle = '#76ff03'; // –ó–µ–ª–µ–Ω—ã–π –Ω–µ–æ–Ω
            ctx.fillRect(x+2, y+16+squash, 28, 16-squash);
            ctx.fillStyle = '#ccff90'; // –ë–ª–∏–∫
            ctx.fillRect(x+6, y+18+squash, 4, 4);
            // –ì–ª–∞–∑–∞
            ctx.fillStyle = '#000';
            ctx.fillRect(x+8, y+20+squash, 4, 4);
            ctx.fillRect(x+20, y+20+squash, 4, 4);
        }
    },

    door: (x, y) => {
        ctx.fillStyle = '#111';
        ctx.fillRect(x, y, 40, 60);
        // –ê—Ä–∫–∞
        ctx.fillStyle = C.brickL;
        ctx.fillRect(x-4, y, 4, 60);
        ctx.fillRect(x+40, y, 4, 60);
        ctx.fillRect(x-4, y-4, 48, 4);
        // –ü–æ—Ä—Ç–∞–ª
        ctx.fillStyle = '#6a1b9a';
        ctx.fillRect(x+4, y+4, 32, 52);
        // –°–∏—è–Ω–∏–µ
        ctx.fillStyle = '#ab47bc';
        ctx.globalAlpha = 0.3;
        ctx.fillRect(x+8, y+8, 24, 44);
        ctx.globalAlpha = 1.0;
    },

    // –†–∏—Å—É–µ–º –ø–æ—Ä—Ç—Ä–µ—Ç –≤ HUD (–æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π canvas)
    drawPortrait: () => {
        const pc = document.getElementById('portrait-canvas');
        const pctx = pc.getContext('2d');
        pctx.fillStyle = '#5d4037'; pctx.fillRect(0,0,50,50); // –§–æ–Ω
        pctx.fillStyle = '#bdbdbd'; // –®–ª–µ–º
        pctx.fillRect(10, 5, 30, 40);
        pctx.fillStyle = '#1976d2'; // –ì–ª–∞–∑–∞
        pctx.fillRect(18, 20, 4, 4); pctx.fillRect(28, 20, 4, 4);
        pctx.strokeStyle = '#000'; pctx.strokeRect(10,5,30,40);
    }
};

// –í—ã–∑—ã–≤–∞–µ–º –æ—Ç—Ä–∏—Å–æ–≤–∫—É –ø–æ—Ä—Ç—Ä–µ—Ç–∞
Art.drawPortrait();

// --- –ò–ì–†–û–í–û–ô –ú–ò–† ---
const Game = {
    state: 'MENU',
    level: 1,
    map: [],
    mapW: 0, mapH: 14,
    entities: [],
    particles: [],
    cam: 0,
    door: null,

    player: { 
        x:0, y:0, w:20, h:30, vx:0, vy:0, 
        hp:100, maxHp:100, mp:100, gold:0, dmg:10, 
        dir:1, iframe:0, atkCd:0, frame:0 
    },

    init: function() {
        if(localStorage.getItem('eq_save')) document.getElementById('btn-continue').style.display = 'block';
        requestAnimationFrame(loop);
    },

    newGame: function() {
        this.level = 1;
        this.player.hp = 100; this.player.gold = 0; this.player.dmg = 10;
        this.startLevel();
    },

    loadGame: function() {
        const d = JSON.parse(localStorage.getItem('eq_save'));
        this.level = d.level;
        this.player.hp = d.hp; this.player.gold = d.gold; this.player.dmg = d.dmg;
        this.player.maxHp = d.maxHp;
        this.startLevel();
    },

    startLevel: function() {
        this.genMap();
        this.state = 'PLAY';
        this.hideMenus();
        this.player.iframe = 0;
        this.player.vx = 0;
    },

    nextLevel: function() {
        this.level++;
        this.startLevel();
    },

    hideMenus: function() {
        document.querySelectorAll('.menu-overlay').forEach(el => el.style.display = 'none');
    },

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä—É–∏–Ω
    genMap: function() {
        this.map = [];
        this.entities = [];
        this.particles = [];
        this.mapW = 40 + (this.level * 5); // –î–ª–∏–Ω–∞ —Ä–∞—Å—Ç–µ—Ç

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—É—Å—Ç–æ—Ç–æ–π
        for(let y=0; y<this.mapH; y++) this.map[y] = new Array(this.mapW).fill(0);

        let ground = 10;
        for(let x=0; x<this.mapW; x++) {
            // –ü–æ–ª
            if(x===0 || x===this.mapW-1) { // –°—Ç–µ–Ω—ã –ø–æ –∫—Ä–∞—è–º
                for(let y=0; y<this.mapH; y++) this.map[y][x] = 1;
            } else {
                // –Ø–º—ã
                if(x > 5 && x < this.mapW-5 && Math.random() < 0.1) {
                    // –Ø–º–∞
                } else {
                    for(let y=ground; y<this.mapH; y++) this.map[y][x] = 1;

                    // –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã
                    if(Math.random() < 0.3) {
                        let py = ground - 3 - Math.floor(Math.random()*2);
                        if(py > 3) this.map[py][x] = 1;
                    }

                    // –í—Ä–∞–≥–∏
                    if(x > 8 && Math.random() < 0.08 && this.map[ground][x]===1) {
                        let type = (Math.random() > 0.6 && this.level > 1) ? 1 : 2; // 1 —Å–∫–µ–ª–µ—Ç, 2 —Å–ª–∏–∑–µ–Ω—å
                        this.entities.push({
                            x: x*TILE, y: (ground-1)*TILE, w:32, h:32, 
                            type: type, hp: 20 + this.level*5, 
                            vx: 1, vy:0, dir:1, frame:0
                        });
                    }
                }
            }
        }

        // –°–ø–∞–≤–Ω
        this.player.x = TILE * 3;
        this.player.y = TILE * 5;
        this.door = { x: (this.mapW-3)*TILE, y: (ground-2)*TILE + 10, w:40, h:60 };
        // –ü–æ–ª –ø–æ–¥ –¥–≤–µ—Ä—å—é –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω
        for(let dx=-1; dx<=2; dx++) this.map[ground][this.mapW-3+dx] = 1; 
    },

    update: function() {
        if(this.state !== 'PLAY') return;

        const p = this.player;
        p.frame++;

        // –§–∏–∑–∏–∫–∞ –ò–≥—Ä–æ–∫–∞
        if(keys.l) { p.vx = -SPEED; p.dir = -1; }
        else if(keys.r) { p.vx = SPEED; p.dir = 1; }
        else p.vx *= 0.8;

        p.vy += GRAVITY;
        p.x += p.vx;
        this.collide(p, 'x');
        p.y += p.vy;
        this.collide(p, 'y');

        // –ü—Ä—ã–∂–æ–∫
        if(keys.u && p.grounded) { p.vy = -JUMP_POWER; p.grounded = false; }

        // –ê—Ç–∞–∫–∞
        if(p.atkCd > 0) p.atkCd--;
        if(keys.atk && p.atkCd === 0) {
            p.atkCd = 20;
            // –•–∏—Ç–±–æ–∫—Å
            let hit = { x: p.dir>0 ? p.x+p.w : p.x-40, y: p.y, w:40, h:p.h };
            this.entities.forEach(e => {
                if(rect(hit, e)) {
                    e.hp -= p.dmg;
                    e.vx = p.dir * 5; e.vy = -3; // –û—Ç–±—Ä–æ—Å
                    this.addPart(e.x, e.y, '#fff', 5);
                    if(e.hp <= 0) {
                        e.dead = true;
                        p.gold += (e.type===1 ? 15 : 5);
                        this.addPart(e.x, e.y, '#ffd700', 10);
                    }
                }
            });
        }

        // –í—Ä–∞–≥–∏
        this.entities.forEach(e => {
            e.frame++;
            e.vy += GRAVITY;

            // AI
            if(e.type === 2) { // –°–ª–∏–∑–µ–Ω—å (—Ç—É–ø–æ–π –ø–∞—Ç—Ä—É–ª—å)
                if(e.grounded && (this.getTileAt(e.x + (e.vx>0?35:-5), e.y+35) === 0 || e.vx===0)) e.vx *= -1;
            } else { // –°–∫–µ–ª–µ—Ç (–∞–≥—Ä–æ)
                let dist = p.x - e.x;
                if(Math.abs(dist) < 200 && Math.abs(p.y - e.y) < 50) e.vx = Math.sign(dist) * 2;
                else e.vx = 0;
            }
            if(e.vx !== 0) e.dir = Math.sign(e.vx);

            e.x += e.vx; this.collide(e, 'x');
            e.y += e.vy; this.collide(e, 'y');

            // –£—Ä–æ–Ω –∏–≥—Ä–æ–∫—É
            if(!e.dead && rect(p, e) && p.iframe === 0) {
                p.hp -= 15;
                p.iframe = 60;
                p.vy = -5; p.vx = -p.dir * 5;
                this.addPart(p.x, p.y, '#b71c1c', 10);
                if(p.hp <= 0) this.gameOver();
            }
        });
        this.entities = this.entities.filter(e => !e.dead);

        // –ß–∞—Å—Ç–∏—Ü—ã
        this.particles.forEach(pt => { pt.x+=pt.vx; pt.y+=pt.vy; pt.life--; });
        this.particles = this.particles.filter(pt => pt.life > 0);

        if(p.iframe > 0) p.iframe--;

        // –°–º–µ—Ä—Ç—å –æ—Ç –ø–∞–¥–µ–Ω–∏—è
        if(p.y > H + 100 || p.y > this.mapH*TILE) { p.hp = 0; this.gameOver(); }

        // –î–≤–µ—Ä—å
        if(rect(p, this.door)) this.levelComplete();

        // –ö–∞–º–µ—Ä–∞
        let target = p.x - W/2;
        target = Math.max(0, Math.min(target, this.mapW*TILE - W));
        this.cam += (target - this.cam) * 0.1;

        // UI Update
        document.getElementById('hp-bar').style.width = (p.hp/p.maxHp)*100 + '%';
        document.getElementById('level-display').innerText = this.level;
        document.getElementById('gold-display').innerText = 'üí∞ ' + p.gold;
    },

    draw: function() {
        // –§–æ–Ω –∏ –æ—á–∏—Å—Ç–∫–∞
        ctx.fillStyle = C.bg;
        ctx.fillRect(0,0,W,H);

        // –ü–∞—Ä–∞–ª–ª–∞–∫—Å –∫–æ–ª–æ–Ω–Ω—ã
        ctx.save();
        ctx.translate(-this.cam * 0.5, 0);
        for(let i=0; i<this.mapW/4; i++) {
            Art.column(i*200, 50, 40, H);
        }
        ctx.restore();

        // –û—Å–Ω–æ–≤–Ω–æ–π —Å–ª–æ–π
        ctx.save();
        ctx.translate(-Math.floor(this.cam), 0);

        // –ö–∞—Ä—Ç–∞ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: —Ä–∏—Å—É–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º–æ–µ)
        let sx = Math.floor(this.cam / TILE);
        let ex = sx + Math.floor(W / TILE) + 2;
        for(let y=0; y<this.mapH; y++) {
            for(let x=sx; x<ex; x++) {
                if(this.map[y] && this.map[y][x]) Art.wall(x*TILE, y*TILE);
            }
        }

        // –î–≤–µ—Ä—å
        Art.door(this.door.x, this.door.y);

        // –í—Ä–∞–≥–∏
        this.entities.forEach(e => Art.enemy(e.x, e.y, e.type, e.dir, e.frame));

        // –ò–≥—Ä–æ–∫
        if(this.player.iframe % 4 < 2) {
            Art.knight(this.player.x, this.player.y, this.player.dir, this.player.frame, this.player.atkCd > 10);
        }

        // –ß–∞—Å—Ç–∏—Ü—ã
        this.particles.forEach(pt => {
            ctx.fillStyle = pt.c;
            ctx.fillRect(pt.x, pt.y, 4, 4);
        });

        ctx.restore();

        // –ú–∏–Ω–∏–∫–∞—Ä—Ç–∞
        this.drawMinimap();
    },

    drawMinimap: function() {
        const mc = document.getElementById('minimap');
        const mctx = mc.getContext('2d');
        mctx.clearRect(0,0,100,60);
        // –†–∏—Å—É–µ–º —Ç–æ—á–∫–∏
        const scaleX = 100 / (this.mapW*TILE);
        const scaleY = 60 / (this.mapH*TILE);

        mctx.fillStyle = '#5d4037'; // –°—Ç–µ–Ω—ã
        for(let y=0; y<this.mapH; y++) {
            for(let x=0; x<this.mapW; x+=2) { // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
                if(this.map[y][x]) mctx.fillRect(x*TILE*scaleX, y*TILE*scaleY, 2, 2);
            }
        }
        mctx.fillStyle = '#0f0'; // –ò–≥—Ä–æ–∫
        mctx.fillRect(this.player.x*scaleX, this.player.y*scaleY, 4, 4);
        mctx.fillStyle = '#f00'; // –í—Ä–∞–≥–∏
        this.entities.forEach(e => mctx.fillRect(e.x*scaleX, e.y*scaleY, 2, 2));
    },

    collide: function(obj, axis) {
        let x1 = Math.floor(obj.x / TILE);
        let x2 = Math.floor((obj.x + obj.w - 0.1) / TILE);
        let y1 = Math.floor(obj.y / TILE);
        let y2 = Math.floor((obj.y + obj.h - 0.1) / TILE);

        if(x1 < 0 || x2 >= this.mapW || y1 < 0 || y2 >= this.mapH) return;

        for(let y=y1; y<=y2; y++) {
            for(let x=x1; x<=x2; x++) {
                if(this.map[y][x]) {
                    if(axis === 'x') {
                        if(obj.vx > 0) obj.x = x*TILE - obj.w;
                        else obj.x = (x+1)*TILE;
                        obj.vx = 0;
                    } else {
                        if(obj.vy > 0) {
                            obj.y = y*TILE - obj.h;
                            obj.grounded = true;
                        } else {
                            obj.y = (y+1)*TILE;
                        }
                        obj.vy = 0;
                    }
                    return;
                }
            }
        }
        if(axis === 'y') obj.grounded = false; // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –∫–æ–ª–ª–∏–∑–∏—é —Å–Ω–∏–∑—É
    },

    getTileAt: function(x, y) {
        let tx = Math.floor(x/TILE);
        let ty = Math.floor(y/TILE);
        if(tx<0||tx>=this.mapW||ty<0||ty>=this.mapH) return 0;
        return this.map[ty][tx];
    },

    addPart: function(x, y, c, n) {
        for(let i=0; i<n; i++) 
            this.particles.push({x, y, vx:(Math.random()-0.5)*8, vy:(Math.random()-0.5)*8, life:20, c});
    },

    levelComplete: function() {
        this.state = 'REST';
        document.getElementById('rest-menu').style.display = 'flex';
        document.getElementById('rest-gold').innerText = this.player.gold;
        this.save();
    },

    save: function() {
        const d = { 
            level: this.level+1, hp:this.player.hp, maxHp:this.player.maxHp, 
            gold:this.player.gold, dmg:this.player.dmg 
        };
        localStorage.setItem('eq_save', JSON.stringify(d));
    },

    buyHeal: function() {
        if(this.player.gold >= 50) {
            this.player.gold -= 50; this.player.hp = Math.min(this.player.hp+50, this.player.maxHp);
            document.getElementById('rest-gold').innerText = this.player.gold;
            document.getElementById('hp-bar').style.width = (this.player.hp/this.player.maxHp)*100 + '%';
        }
    },

    buyUpgrade: function() {
        if(this.player.gold >= 100) {
            this.player.gold -= 100; this.player.dmg += 5;
            document.getElementById('rest-gold').innerText = this.player.gold;
        }
    },

    gameOver: function() {
        this.state = 'GAMEOVER';
        document.getElementById('game-over').style.display = 'flex';
        localStorage.removeItem('eq_save');
    }
};

function rect(r1, r2) {
    return !(r2.x > r1.x + r1.w || r2.x + r2.w < r1.x || r2.y > r1.y + r1.h || r2.y + r2.h < r1.y);
}

function loop() {
    Game.update();
    Game.draw();
    requestAnimationFrame(loop);
}

Game.init();

</script>
</body>
</html>