<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ETERNA-QUEST: Dungeon Crawler</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            background-color: #0d0e15;
            overflow: hidden;
            font-family: 'Press Start 2P', cursive;
            touch-action: none; /* –û—Ç–∫–ª—é—á–∞–µ–º –∑—É–º –∏ —Å–∫—Ä–æ–ª–ª –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            image-rendering: pixelated; /* –ß–µ—Ç–∫–∏–µ –ø–∏–∫—Å–µ–ª–∏ */
            box-shadow: 0 0 20px #000;
        }

        /* --- UI –°–õ–û–ò --- */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏ –ü—Ä–∏–≤–∞–ª */
        .menu-box {
            pointer-events: auto;
            background: rgba(20, 16, 19, 0.95);
            border: 4px solid #8b7355;
            padding: 20px;
            text-align: center;
            color: #dcdcdc;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            max-width: 400px;
            width: 80%;
        }

        .menu-title {
            color: #ffd700;
            font-size: 24px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0 #000;
        }

        .btn {
            background: #3e3e42;
            border: 2px solid #555;
            color: white;
            font-family: inherit;
            padding: 15px;
            margin: 10px 0;
            width: 100%;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 12px;
            transition: all 0.1s;
        }

        .btn:active { transform: translateY(2px); background: #555; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-green { background: #2e7d32; border-color: #4caf50; }
        .btn-red { background: #b71c1c; border-color: #f44336; }

        /* --- –ú–û–ë–ò–õ–¨–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï --- */
        #mobile-controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            height: 150px;
            pointer-events: none;
            display: none; /* –í–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS –µ—Å–ª–∏ —Ç–∞—á-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ */
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
        }

        .control-group {
            pointer-events: auto;
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .touch-btn {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            backdrop-filter: blur(2px);
        }

        .touch-btn:active { background: rgba(255, 255, 255, 0.4); }
        .btn-big { width: 70px; height: 70px; background: rgba(180, 50, 50, 0.3); border-color: #f44336; } /* –ê—Ç–∞–∫–∞ */
        .btn-jump { background: rgba(50, 180, 50, 0.3); border-color: #4caf50; }

    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <!-- UI –°–ª–æ–π: –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
    <div id="main-menu" class="ui-layer">
        <div class="menu-box" style="display: block;">
            <div class="menu-title">ETERNA QUEST</div>
            <div style="margin-bottom: 20px; font-size: 10px; color: #888;">–î–†–ï–í–ù–ò–ï –†–£–ò–ù–´ –ñ–î–£–¢</div>
            <button id="btn-continue" class="btn btn-green" style="display:none;" onclick="Game.loadGame()">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
            <button class="btn" onclick="Game.newGame()">–ù–û–í–ê–Ø –ò–ì–†–ê</button>
        </div>
    </div>

    <!-- UI –°–ª–æ–π: –ü—Ä–∏–≤–∞–ª (–ú–∞–≥–∞–∑–∏–Ω) -->
    <div id="rest-menu" class="ui-layer" style="display: none;">
        <div class="menu-box" style="display: block;">
            <div class="menu-title">–ü–†–ò–í–ê–õ</div>
            <p>–£—Ä–æ–≤–µ–Ω—å <span id="rest-lvl">1</span> –ø—Ä–æ–π–¥–µ–Ω!</p>
            <p>–ó–æ–ª–æ—Ç–æ: <span id="rest-gold" style="color:gold">0</span></p>
            <hr style="border-color:#444">

            <button class="btn" onclick="Game.buyHeal()">
                ‚ù§Ô∏è –õ–µ—á–µ–Ω–∏–µ (+30 HP) <br><span style="color:gold; font-size:10px;">50 –∑–æ–ª.</span>
            </button>

            <button class="btn" onclick="Game.buyUpgrade()">
                ‚öîÔ∏è –ó–∞—Ç–æ—á–∏—Ç—å –º–µ—á (+1 –£—Ä–æ–Ω) <br><span style="color:gold; font-size:10px;">100 –∑–æ–ª.</span>
            </button>

            <button class="btn btn-green" onclick="Game.nextLevel()">
                üö™ –°–õ–ï–î–£–Æ–©–ò–ô –£–†–û–í–ï–ù–¨
            </button>
        </div>
    </div>

    <!-- UI –°–ª–æ–π: Game Over -->
    <div id="game-over" class="ui-layer" style="display: none;">
        <div class="menu-box" style="display: block; border-color: #b71c1c;">
            <div class="menu-title" style="color: #f44336;">–¢–´ –ü–û–ì–ò–ë</div>
            <p>–¢–≤–æ–π –ø—É—Ç—å –æ–∫–æ–Ω—á–µ–Ω.</p>
            <button class="btn btn-red" onclick="location.reload()">–í –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ</button>
        </div>
    </div>

    <!-- –ú–æ–±–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
    <div id="mobile-controls">
        <div class="control-group">
            <div class="touch-btn" id="btn-left">‚¨ÖÔ∏è</div>
            <div class="touch-btn" id="btn-right">‚û°Ô∏è</div>
        </div>
        <div class="control-group">
            <div class="touch-btn btn-big" id="btn-attack">‚öîÔ∏è</div>
            <div class="touch-btn btn-jump" id="btn-jump">‚¨ÜÔ∏è</div>
        </div>
    </div>
</div>

<script>
/**
 * ETERNA-QUEST
 * Single File Game Engine
 */

// --- –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ù–ê–°–¢–†–û–ô–ö–ò ---
const TILE_SIZE = 32;
const GRAVITY = 0.6;
const FRICTION = 0.8;
const MOVE_SPEED = 5;
const JUMP_FORCE = 12;

// –¶–≤–µ—Ç–∞
const COLORS = {
    bg: '#1a1a24', // –¢–µ–º–Ω—ã–π —Å–∏–Ω–µ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
    bg_col: '#121218',
    tile: '#5d4037', // –ö–æ—Ä–∏—á–Ω–µ–≤—ã–π –∫–∏—Ä–ø–∏—á
    tile_light: '#795548',
    tile_dark: '#3e2723',
    hero: '#bdbdbd', // –°–µ—Ä–µ–±—Ä—è–Ω–∞—è –±—Ä–æ–Ω—è
    hero_acc: '#1976d2', // –°–∏–Ω–∏–π –ø–ª–∞—â
    slime: '#76ff03',
    skeleton: '#eeeeee',
    skull: '#ffeb3b',
    gold: '#ffd700',
    door: '#000000',
    door_frame: '#5d4037'
};

// --- –î–í–ò–ñ–û–ö –ò –í–í–û–î ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let width, height;
// –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ Canvas
function resize() {
    width = window.innerWidth;
    height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;
    ctx.imageSmoothingEnabled = false; // –ü–∏–∫—Å–µ–ª—å-–∞—Ä—Ç —Ä–µ–∂–∏–º
}
window.addEventListener('resize', resize);
resize();

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
const keys = { left: false, right: false, up: false, attack: false };

window.addEventListener('keydown', (e) => {
    if (e.code === 'KeyA' || e.code === 'ArrowLeft') keys.left = true;
    if (e.code === 'KeyD' || e.code === 'ArrowRight') keys.right = true;
    if (e.code === 'Space' || e.code === 'ArrowUp') keys.up = true;
    if (e.code === 'KeyZ' || e.key === 'z') keys.attack = true;
});

window.addEventListener('keyup', (e) => {
    if (e.code === 'KeyA' || e.code === 'ArrowLeft') keys.left = false;
    if (e.code === 'KeyD' || e.code === 'ArrowRight') keys.right = false;
    if (e.code === 'Space' || e.code === 'ArrowUp') keys.up = false;
    if (e.code === 'KeyZ' || e.key === 'z') keys.attack = false;
});

// –¢–∞—á-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
if (isTouchDevice) {
    document.getElementById('mobile-controls').style.display = 'flex';

    const bindTouch = (id, key) => {
        const el = document.getElementById(id);
        el.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; });
        el.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
    };

    bindTouch('btn-left', 'left');
    bindTouch('btn-right', 'right');
    bindTouch('btn-jump', 'up');
    bindTouch('btn-attack', 'attack');
}

// --- –°–ü–†–ê–ô–¢–´ (–ü—Ä–æ–≥—Ä–∞–º–º–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞) ---
const Draw = {
    rect: (x, y, w, h, c) => { ctx.fillStyle = c; ctx.fillRect(Math.floor(x), Math.floor(y), w, h); },

    // –†–∏—Å—É–µ–º —Ç–∞–π–ª (–∫–∏—Ä–ø–∏—á–Ω–∞—è —Å—Ç–µ–Ω–∞)
    tile: (x, y) => {
        Draw.rect(x, y, TILE_SIZE, TILE_SIZE, COLORS.tile);
        Draw.rect(x, y, TILE_SIZE, 2, COLORS.tile_light); // –ë–ª–∏–∫
        Draw.rect(x+4, y+4, 10, 6, COLORS.tile_dark); // –ö–∏—Ä–ø–∏—á–∏–∫ 1
        Draw.rect(x+18, y+16, 10, 6, COLORS.tile_dark); // –ö–∏—Ä–ø–∏—á–∏–∫ 2
        Draw.rect(x, y+TILE_SIZE-2, TILE_SIZE, 2, 'rgba(0,0,0,0.3)'); // –¢–µ–Ω—å
    },

    knight: (x, y, dir, isAttacking) => {
        // –¢–µ–ª–æ
        Draw.rect(x+4, y+6, 24, 26, COLORS.hero); 
        // –®–ª–µ–º (–∑–∞–±—Ä–∞–ª–æ)
        Draw.rect(x+8, y+8, 16, 6, '#333'); 
        Draw.rect(x+10, y+10, 4, 2, '#000'); // –ì–ª–∞–∑–∞
        if(dir>0) Draw.rect(x+18, y+10, 4, 2, '#000'); 
        else Draw.rect(x+10, y+10, 4, 2, '#000');

        // –ü–ª–∞—â
        Draw.rect(x + (dir>0?0:20), y+10, 8, 18, COLORS.hero_acc);

        // –ú–µ—á
        if (isAttacking) {
            ctx.fillStyle = '#fff';
            // –í–∑–º–∞—Ö (–±–µ–ª–∞—è –¥—É–≥–∞ - –ø—Ä–æ—Å—Ç–æ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –¥–ª—è –ø–∏–∫—Å–µ–ª—å–Ω–æ—Å—Ç–∏)
            let sx = dir > 0 ? x + 24 : x - 24;
            Draw.rect(sx, y + 10, 24, 8, '#fff');
        } else {
            // –ú–µ—á –≤ –Ω–æ–∂–Ω–∞—Ö/—Ä—É–∫–µ
            let sx = dir > 0 ? x + 20 : x - 4;
            Draw.rect(sx, y + 18, 4, 12, '#999');
        }
    },

    slime: (x, y) => {
        Draw.rect(x, y+16, 32, 16, COLORS.slime);
        Draw.rect(x+4, y+12, 24, 4, COLORS.slime); // –í–µ—Ä—Ö
        // –ì–ª–∞–∑–∞
        ctx.fillStyle = '#000';
        Draw.rect(x+6, y+20, 4, 4, '#000');
        Draw.rect(x+22, y+20, 4, 4, '#000');
    },

    skeleton: (x, y, dir) => {
        Draw.rect(x+8, y+2, 16, 14, COLORS.skeleton); // –ß–µ—Ä–µ–ø
        Draw.rect(x+10, y+6, 4, 4, '#000'); // –ì–ª–∞–∑
        Draw.rect(x+18, y+6, 4, 4, '#000'); // –ì–ª–∞–∑
        Draw.rect(x+12, y+18, 8, 14, '#aaa'); // –†–µ–±—Ä–∞
        Draw.rect(x+6, y+18, 4, 12, '#ddd'); // –†—É–∫–∞
        Draw.rect(x+22, y+18, 4, 12, '#ddd'); // –†—É–∫–∞

        // –ú–µ—á —Å–∫–µ–ª–µ—Ç–∞
        let sx = dir > 0 ? x + 24 : x - 8;
        Draw.rect(sx, y + 20, 16, 4, '#ccc');
    },

    skull: (x, y) => {
        Draw.rect(x+4, y+4, 24, 20, COLORS.skull);
        Draw.rect(x+8, y+10, 6, 6, '#000');
        Draw.rect(x+18, y+10, 6, 6, '#000');
        // –ö—Ä—ã–ª—å—è —Å—Ö–µ–º–∞—Ç–∏—á–Ω–æ
        Draw.rect(x-4, y+8, 8, 4, '#fff');
        Draw.rect(x+28, y+8, 8, 4, '#fff');
    },

    coin: (x, y) => {
        Draw.rect(x+8, y+8, 16, 16, COLORS.gold);
        Draw.rect(x+12, y+12, 4, 8, '#bfa030'); // –ë–ª–∏–∫
    },

    door: (x, y) => {
        Draw.rect(x, y, TILE_SIZE*1.5, TILE_SIZE*2, COLORS.door_frame);
        Draw.rect(x+4, y+4, TILE_SIZE*1.5 - 8, TILE_SIZE*2 - 4, '#000');
        // –ü–æ—Ä—Ç–∞–ª —ç—Ñ—Ñ–µ–∫—Ç
        ctx.fillStyle = '#4a148c';
        ctx.globalAlpha = 0.5;
        Draw.rect(x+8, y+8, TILE_SIZE*1.5 - 16, TILE_SIZE*2 - 8, '#7b1fa2');
        ctx.globalAlpha = 1.0;
    }
};

// --- –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ---

class Entity {
    constructor(x, y, w, h) {
        this.x = x; this.y = y; this.w = w; this.h = h;
        this.vx = 0; this.vy = 0;
        this.grounded = false;
        this.dir = 1; // 1 right, -1 left
        this.dead = false;
    }

    update(map) {
        // –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è
        this.vy += GRAVITY;

        // –ü–æ X
        this.x += this.vx;
        this.checkCollision(map, 'x');

        // –ü–æ Y
        this.y += this.vy;
        this.grounded = false;
        this.checkCollision(map, 'y');
    }

    checkCollision(map, axis) {
        // –ü—Ä–æ—Å—Ç–∞—è AABB —Å —Ç–∞–π–ª–∞–º–∏
        let startX = Math.floor(this.x / TILE_SIZE);
        let endX = Math.floor((this.x + this.w - 0.1) / TILE_SIZE);
        let startY = Math.floor(this.y / TILE_SIZE);
        let endY = Math.floor((this.y + this.h - 0.1) / TILE_SIZE);

        for (let y = startY; y <= endY; y++) {
            for (let x = startX; x <= endX; x++) {
                if (map[y] && map[y][x] === 1) { // 1 = —Å—Ç–µ–Ω–∞
                    if (axis === 'x') {
                        if (this.vx > 0) this.x = x * TILE_SIZE - this.w;
                        else this.x = (x + 1) * TILE_SIZE;
                        this.vx = 0;
                    } else {
                        if (this.vy > 0) {
                            this.y = y * TILE_SIZE - this.h;
                            this.grounded = true;
                        } else {
                            this.y = (y + 1) * TILE_SIZE;
                        }
                        this.vy = 0;
                    }
                    return;
                }
            }
        }
    }
}

class Player extends Entity {
    constructor(x, y) {
        super(x, y, 32, 32);
        this.hp = 100;
        this.maxHp = 100;
        this.gold = 0;
        this.atkDmg = 10;
        this.iFrames = 0;
        this.atkCooldown = 0;
    }

    control() {
        // –î–≤–∏–∂–µ–Ω–∏–µ
        if (keys.left) { this.vx = -MOVE_SPEED; this.dir = -1; }
        else if (keys.right) { this.vx = MOVE_SPEED; this.dir = 1; }
        else { this.vx *= FRICTION; }

        // –ü—Ä—ã–∂–æ–∫
        if (keys.up && this.grounded) {
            this.vy = -JUMP_FORCE;
            this.grounded = false;
        }

        // –ê—Ç–∞–∫–∞
        if (keys.attack && this.atkCooldown <= 0) {
            this.atkCooldown = 20; // –ö–∞–¥—Ä–æ–≤
            // –•–∏—Ç–±–æ–∫—Å –∞—Ç–∞–∫–∏
            let hitX = this.dir > 0 ? this.x + this.w : this.x - 40;
            let hitRect = { x: hitX, y: this.y, w: 40, h: this.h };

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–∞–≥–æ–≤
            Game.enemies.forEach(e => {
                if (rectIntersect(hitRect, e)) {
                    e.takeDamage(this.atkDmg, this.dir);
                    Game.spawnParticle(e.x + e.w/2, e.y, '#fff');
                }
            });
        }

        if (this.atkCooldown > 0) this.atkCooldown--;
        if (this.iFrames > 0) this.iFrames--;
    }

    takeDamage(amount) {
        if (this.iFrames > 0) return;
        this.hp -= amount;
        this.iFrames = 60; // 1 —Å–µ–∫ –Ω–µ—É—è–∑–≤–∏–º–æ—Å—Ç–∏
        this.vy = -5; // –û—Ç–±—Ä–æ—Å
        if (this.hp <= 0) Game.gameOver();
    }
}

class Enemy extends Entity {
    constructor(x, y, type) {
        super(x, y, 32, 32);
        this.type = type;
        this.hp = 20 + Game.level * 2;
        this.startY = y;
        this.timer = 0;
    }

    ai(player, map) {
        this.timer++;

        if (this.type === 'slime') {
            // –ü–∞—Ç—Ä—É–ª—å
            if (this.vx === 0) this.vx = 2; // –°—Ç–∞—Ä—Ç
            // –ï—Å–ª–∏ —É–ø–µ—Ä—Å—è –≤ —Å—Ç–µ–Ω—É –∏–ª–∏ –∫—Ä–∞–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (—É–ø—Ä–æ—â–µ–Ω–Ω–æ - —Ç–æ–ª—å–∫–æ —Å—Ç–µ–Ω—ã –ø–æ–∫–∞)
            let checkX = this.vx > 0 ? this.x + this.w + 5 : this.x - 5;
            // –ü—Ä–æ—Å—Ç–µ–π—à–∞—è —Ñ–∏–∑–∏–∫–∞ Entity —Å–∞–º–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç vx, –µ—Å–ª–∏ —Å—Ç–µ–Ω–∞.
            // –ù–∞–º –Ω—É–∂–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å:
            let gridX = Math.floor((this.x + (this.vx>0?this.w:0) + this.vx) / TILE_SIZE);
            let gridY = Math.floor((this.y + this.h) / TILE_SIZE);

            // –ï—Å–ª–∏ –≤–ø–µ—Ä–µ–¥–∏ —è–º–∞
            if (map[gridY] && map[gridY][gridX] === 0 && this.grounded) {
                this.vx *= -1;
            }
            // –ï—Å–ª–∏ —É–ø–µ—Ä—Å—è (vx –æ–±–Ω—É–ª–∏–ª—Å—è —Ñ–∏–∑–∏–∫–æ–π)
            if (Math.abs(this.vx) < 0.1) this.vx = this.dir * 2 * -1;

            this.dir = Math.sign(this.vx);

        } else if (this.type === 'skeleton') {
            // –ê–≥—Ä–æ
            let dist = Math.abs(player.x - this.x);
            if (dist < 200 && Math.abs(player.y - this.y) < 64) {
                if (player.x < this.x) this.vx = -1.5;
                else this.vx = 1.5;
            } else {
                this.vx = 0;
            }
            this.dir = this.vx !== 0 ? Math.sign(this.vx) : this.dir;

        } else if (this.type === 'skull') {
            // –ü–æ–ª–µ—Ç —Å–∏–Ω—É—Å–æ–∏–¥–æ–π
            this.vy = 0; // –û—Ç–∫–ª—é—á–∞–µ–º –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—é —Ö–∞–∫–æ–º
            this.y = this.startY + Math.sin(this.timer * 0.05) * 50;
            this.vx = -2;
            this.dir = -1;
        }

        // –£—Ä–æ–Ω –∏–≥—Ä–æ–∫—É
        if (rectIntersect(this, player)) {
            player.takeDamage(10 + Game.level);
        }
    }

    takeDamage(dmg, dir) {
        this.hp -= dmg;
        this.vx = dir * 5; // –û—Ç–±—Ä–æ—Å
        this.vy = -3;
        if (this.hp <= 0) {
            this.dead = true;
            // –î—Ä–æ–ø –∑–æ–ª–æ—Ç–∞
            Game.spawnCoin(this.x, this.y);
        }
    }

    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º update –¥–ª—è —á–µ—Ä–µ–ø–∞ (–±–µ–∑ –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏–∏)
    update(map) {
        if(this.type === 'skull') {
             this.x += this.vx;
             // –ü—Ä–æ—Å—Ç–æ –¥–≤–∏–≥–∞–µ–º Y –≤ ai
        } else {
            super.update(map);
        }
    }
}

// --- –°–ò–°–¢–ï–ú–ê –ò–ì–†–´ ---

const Game = {
    state: 'MENU', // MENU, PLAY, REST, GAMEOVER
    level: 1,
    map: [],
    mapWidth: 0,
    mapHeight: 15, // –í—ã—Å–æ—Ç–∞ —É—Ä–æ–≤–Ω—è –≤ —Ç–∞–π–ª–∞—Ö
    player: null,
    enemies: [],
    particles: [],
    coins: [],
    door: null,
    camera: { x: 0 },

    init: function() {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        const save = localStorage.getItem('eterna_save');
        if (save) {
            document.getElementById('btn-continue').style.display = 'block';
        }
    },

    newGame: function() {
        this.level = 1;
        this.player = new Player(100, 100);
        this.startGame();
    },

    loadGame: function() {
        const save = JSON.parse(localStorage.getItem('eterna_save'));
        this.level = save.level;
        this.player = new Player(0,0);
        this.player.hp = save.hp;
        this.player.maxHp = save.maxHp;
        this.player.gold = save.gold;
        this.player.atkDmg = save.atkDmg;
        this.startGame();
    },

    startGame: function() {
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('game-over').style.display = 'none';
        document.getElementById('rest-menu').style.display = 'none';
        this.generateLevel();
        this.state = 'PLAY';
        loop();
    },

    generateLevel: function() {
        // –ü—Ä–æ—Ü–µ–¥—É—Ä–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
        this.map = [];
        this.enemies = [];
        this.coins = [];
        this.particles = [];

        // –î–ª–∏–Ω–∞ —É—Ä–æ–≤–Ω—è —Ä–∞—Å—Ç–µ—Ç —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
        this.mapWidth = 50 + (this.level * 10); 

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—É—Å—Ç–æ—Ç–æ–π
        for (let y = 0; y < this.mapHeight; y++) {
            this.map[y] = new Array(this.mapWidth).fill(0);
        }

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–ª –∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
        let groundY = 10;
        for (let x = 0; x < this.mapWidth; x++) {
            // –ì—Ä–∞–Ω–∏—Ü—ã
            if (x === 0 || x === this.mapWidth - 1) {
                for(let y=0; y<this.mapHeight; y++) this.map[y][x] = 1;
                continue;
            }

            // –Ø–º—ã (—Å —à–∞–Ω—Å–æ–º, –Ω–æ –Ω–µ –≤ –Ω–∞—á–∞–ª–µ –∏ –Ω–µ –≤ –∫–æ–Ω—Ü–µ)
            if (x > 10 && x < this.mapWidth - 10 && Math.random() < 0.1) {
                // –Ø–º–∞ —à–∏—Ä–∏–Ω–æ–π 2-3
                x += Math.floor(Math.random() * 2) + 1;
                continue;
            }

            // –ü–æ–ª
            for (let y = groundY; y < this.mapHeight; y++) {
                this.map[y][x] = 1;
            }

            // –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã
            if (x > 5 && x < this.mapWidth - 5 && Math.random() < 0.3) {
                let platY = groundY - 3 - Math.floor(Math.random() * 2);
                if (platY > 2) {
                    this.map[platY][x] = 1;
                    // –í—Ä–∞–≥ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ?
                    if (Math.random() < 0.2) this.spawnEnemy(x * TILE_SIZE, (platY - 1) * TILE_SIZE);
                }
            }

            // –í—Ä–∞–≥–∏ –Ω–∞ –∑–µ–º–ª–µ
            if (x > 10 && x < this.mapWidth - 10 && Math.random() < 0.05) {
                this.spawnEnemy(x * TILE_SIZE, (groundY - 1) * TILE_SIZE);
            }
        }

        // –°–ø–∞–≤–Ω –∏–≥—Ä–æ–∫–∞
        this.player.x = TILE_SIZE * 3;
        this.player.y = TILE_SIZE * 5;
        this.player.vx = 0; this.player.vy = 0;
        this.player.dir = 1;

        // –î–≤–µ—Ä—å
        this.door = { x: (this.mapWidth - 4) * TILE_SIZE, y: (groundY - 2) * TILE_SIZE, w: 40, h: 64 };
    },

    spawnEnemy: function(x, y) {
        let r = Math.random();
        let type = 'slime';
        if (this.level > 1 && r > 0.6) type = 'skeleton';
        if (this.level > 3 && r > 0.9) type = 'skull';
        this.enemies.push(new Enemy(x, y, type));
    },

    spawnCoin: function(x, y) {
        this.coins.push({ x: x, y: y, w: 16, h: 16, vy: -5 });
    },

    spawnParticle: function(x, y, color) {
        this.particles.push({x, y, vx: (Math.random()-0.5)*5, vy: (Math.random()-0.5)*5, life: 20, color});
    },

    update: function() {
        if (this.state !== 'PLAY') return;

        // –ò–≥—Ä–æ–∫
        this.player.control();
        this.player.update(this.map);

        // –ü–∞–¥–µ–Ω–∏–µ –≤ –±–µ–∑–¥–Ω—É
        if (this.player.y > height + 100 || this.player.y > this.mapHeight * TILE_SIZE) {
            this.player.hp = 0;
            this.gameOver();
        }

        // –ö–∞–º–µ—Ä–∞ (—Å–ª–µ–¥–∏—Ç –∑–∞ –∏–≥—Ä–æ–∫–æ–º)
        let targetCamX = this.player.x - width / 2;
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
        targetCamX = Math.max(0, Math.min(targetCamX, (this.mapWidth * TILE_SIZE) - width));
        this.camera.x += (targetCamX - this.camera.x) * 0.1; // –ü–ª–∞–≤–Ω–æ—Å—Ç—å

        // –í—Ä–∞–≥–∏
        this.enemies.forEach(e => {
            e.ai(this.player, this.map);
            e.update(this.map);
        });
        this.enemies = this.enemies.filter(e => !e.dead);

        // –ú–æ–Ω–µ—Ç—ã
        this.coins.forEach(c => {
            c.vy += GRAVITY;
            c.y += c.vy;
            // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å –ø–æ–ª–æ–º (–ø—Ä–æ—Å—Ç–æ–µ)
            if (c.y > this.player.y + 200) c.picked = true; // —É–¥–∞–ª—è–µ–º –µ—Å–ª–∏ —É–ø–∞–ª–∏

            if (rectIntersect(this.player, c)) {
                this.player.gold += 10;
                c.picked = true;
            }
        });
        this.coins = this.coins.filter(c => !c.picked);

        // –ß–∞—Å—Ç–∏—Ü—ã
        this.particles.forEach(p => { p.x += p.vx; p.y += p.vy; p.life--; });
        this.particles = this.particles.filter(p => p.life > 0);

        // –í—ã—Ö–æ–¥
        if (rectIntersect(this.player, this.door)) {
            this.completeLevel();
        }
    },

    draw: function() {
        // –û—á–∏—Å—Ç–∫–∞
        ctx.fillStyle = COLORS.bg;
        ctx.fillRect(0, 0, width, height);

        // –§–æ–Ω (–ü–∞—Ä–∞–ª–ª–∞–∫—Å –∫–æ–ª–æ–Ω–Ω—ã)
        ctx.fillStyle = COLORS.bg_col;
        for(let i=0; i<10; i++) {
            let x = (i * 200) - (this.camera.x * 0.5) % 200;
            ctx.fillRect(x, 0, 40, height);
        }

        ctx.save();
        ctx.translate(-Math.floor(this.camera.x), 0);

        // –ö–∞—Ä—Ç–∞
        for (let y = 0; y < this.mapHeight; y++) {
            // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: —Ä–µ–Ω–¥–µ—Ä–∏–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º–æ–µ
            let startX = Math.floor(this.camera.x / TILE_SIZE);
            let endX = startX + Math.floor(width / TILE_SIZE) + 1;
            for (let x = startX; x <= endX; x++) {
                if (this.map[y] && this.map[y][x] === 1) {
                    Draw.tile(x * TILE_SIZE, y * TILE_SIZE);
                }
            }
        }

        // –î–≤–µ—Ä—å
        Draw.door(this.door.x, this.door.y);

        // –ú–æ–Ω–µ—Ç—ã
        this.coins.forEach(c => Draw.coin(c.x, c.y));

        // –í—Ä–∞–≥–∏
        this.enemies.forEach(e => {
            if (e.type === 'slime') Draw.slime(e.x, e.y);
            if (e.type === 'skeleton') Draw.skeleton(e.x, e.y, e.dir);
            if (e.type === 'skull') Draw.skull(e.x, e.y);
        });

        // –ò–≥—Ä–æ–∫
        if (this.player.iFrames % 4 < 2) { // –ú–∏–≥–∞–Ω–∏–µ –ø—Ä–∏ —É—Ä–æ–Ω–µ
            Draw.knight(this.player.x, this.player.y, this.player.dir, this.player.atkCooldown > 15);
        }

        // –ß–∞—Å—Ç–∏—Ü—ã
        this.particles.forEach(p => Draw.rect(p.x, p.y, 4, 4, p.color));

        ctx.restore();

        // --- HUD ---
        this.drawHUD();
    },

    drawHUD: function() {
        // –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å
        ctx.fillStyle = 'rgba(0,0,0,0.7)';
        ctx.fillRect(0, 0, width, 50);
        ctx.fillStyle = '#fff';

        // –ü–æ—Ä—Ç—Ä–µ—Ç –∏ —Å—Ç–∞—Ç—ã
        Draw.rect(10, 10, 30, 30, '#ccc'); // –ü–æ—Ä—Ç—Ä–µ—Ç

        // HP Bar
        ctx.fillStyle = '#333'; ctx.fillRect(50, 10, 150, 12);
        ctx.fillStyle = '#f44336'; ctx.fillRect(50, 10, 150 * (this.player.hp / this.player.maxHp), 12);

        // MP Bar (–î–µ–∫–æ—Ä, –ø–æ–∫–∞ –Ω–µ—Ç –º–∞–≥–∏–∏)
        ctx.fillStyle = '#333'; ctx.fillRect(50, 26, 120, 8);
        ctx.fillStyle = '#2196f3'; ctx.fillRect(50, 26, 120, 8);

        // –ó–æ–ª–æ—Ç–æ
        ctx.fillStyle = COLORS.gold;
        ctx.fillText(`$${this.player.gold}`, 210, 30);

        // –£—Ä–æ–≤–µ–Ω—å (—Ü–µ–Ω—Ç—Ä)
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'center';
        ctx.fillText(`–£–†–û–í–ï–ù–¨ ${this.level}`, width / 2, 35);
        ctx.textAlign = 'left';

        // –ú–∏–Ω–∏–∫–∞—Ä—Ç–∞ (—Å–ø—Ä–∞–≤–∞)
        let mapW = 100;
        let mapH = 40;
        let mapX = width - mapW - 10;
        let mapY = 10;
        ctx.fillStyle = 'rgba(0,0,0,0.5)';
        ctx.fillRect(mapX, mapY, mapW, mapH);

        // –¢–æ—á–∫–∞ –∏–≥—Ä–æ–∫–∞ –Ω–∞ –º–∏–Ω–∏–∫–∞—Ä—Ç–µ
        let px = (this.player.x / (this.mapWidth * TILE_SIZE)) * mapW;
        let py = (this.player.y / (this.mapHeight * TILE_SIZE)) * mapH;
        ctx.fillStyle = '#0f0';
        ctx.fillRect(mapX + px, mapY + py, 4, 4);

        // –°–ø—Ä–∞–≤–∞ —Å–ª–æ—Ç—ã (–í–∏–∑—É–∞–ª)
        if (!isTouchDevice) {
            let slotY = 60;
            for(let i=0; i<3; i++) {
                Draw.rect(width - 40, slotY + i*45, 32, 32, 'rgba(0,0,0,0.5)');
                ctx.strokeStyle = '#555'; ctx.strokeRect(width - 40, slotY + i*45, 32, 32);
            }
            ctx.fillStyle = '#fff'; ctx.font = '10px monospace';
            ctx.fillText('Z', width - 38, slotY + 40); // –ü–æ–¥—Å–∫–∞–∑–∫–∞
        }
    },

    completeLevel: function() {
        this.state = 'REST';
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        const save = {
            level: this.level + 1,
            hp: this.player.hp,
            maxHp: this.player.maxHp,
            gold: this.player.gold,
            atkDmg: this.player.atkDmg
        };
        localStorage.setItem('eterna_save', JSON.stringify(save));

        // UI –ü—Ä–∏–≤–∞–ª–∞
        document.getElementById('rest-menu').style.display = 'flex';
        document.getElementById('rest-lvl').innerText = this.level;
        document.getElementById('rest-gold').innerText = this.player.gold;
    },

    nextLevel: function() {
        this.level++;
        document.getElementById('rest-menu').style.display = 'none';
        this.generateLevel();
        this.state = 'PLAY';
    },

    buyHeal: function() {
        if (this.player.gold >= 50 && this.player.hp < this.player.maxHp) {
            this.player.gold -= 50;
            this.player.hp = Math.min(this.player.hp + 30, this.player.maxHp);
            document.getElementById('rest-gold').innerText = this.player.gold;
        }
    },

    buyUpgrade: function() {
        if (this.player.gold >= 100) {
            this.player.gold -= 100;
            this.player.atkDmg += 5; // –°–∏–ª—å–Ω—ã–π –±—É—Å—Ç
            document.getElementById('rest-gold').innerText = this.player.gold;
        }
    },

    gameOver: function() {
        this.state = 'GAMEOVER';
        localStorage.removeItem('eterna_save'); // –•–∞—Ä–¥–∫–æ—Ä - —É–¥–∞–ª—è–µ–º —Å–µ–π–≤ (–∏–ª–∏ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å)
        document.getElementById('game-over').style.display = 'flex';
    }
};

// –£—Ç–∏–ª–∏—Ç–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π
function rectIntersect(r1, r2) {
    return !(r2.x > r1.x + r1.w || 
             r2.x + r2.w < r1.x || 
             r2.y > r1.y + r1.h || 
             r2.y + r2.h < r1.y);
}

// –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
function loop() {
    Game.update();
    Game.draw();
    if (Game.state === 'PLAY') requestAnimationFrame(loop);
}

// –°—Ç–∞—Ä—Ç
Game.init();

</script>
</body>
</html>