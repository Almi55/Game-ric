<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Galaxy Breaker</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Russo+One&display=swap');

        body {
            margin: 0;
            background-color: #080010; /* Темно-фиолетовый фон */
            color: #fff;
            overflow: hidden;
            font-family: 'Russo One', sans-serif;
            touch-action: none;
        }

        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        /* UI */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 0, 20, 0.85);
            backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 10;
        }

        #panel {
            background: linear-gradient(135deg, #1a0b2e, #2d1b4e);
            border: 2px solid #d000ff;
            box-shadow: 0 0 40px rgba(208, 0, 255, 0.3);
            padding: 25px;
            border-radius: 15px;
            width: 350px;
            max-height: 90vh;
            overflow-y: auto;
        }

        #panel::-webkit-scrollbar { width: 5px; }
        #panel::-webkit-scrollbar-thumb { background: #d000ff; border-radius: 5px; }

        h2 { margin: 0 0 15px 0; color: #d000ff; text-align: center; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px #d000ff; }

        .group { margin-bottom: 12px; }
        label { font-size: 12px; color: #e0ccff; display: flex; justify-content: space-between; margin-bottom: 4px; }
        .val { color: #fff; font-weight: normal; }

        input[type=range] {
            width: 100%; height: 6px; 
            background: #4a2b75; border-radius: 3px;
            accent-color: #d000ff; cursor: pointer;
            appearance: none;
        }

        button {
            width: 100%; padding: 15px; margin-top: 15px;
            border: none; border-radius: 8px;
            font-family: inherit; font-size: 18px; text-transform: uppercase;
            cursor: pointer; transition: 0.2s;
            font-weight: bold;
        }

        .btn-start { background: #d000ff; color: #fff; box-shadow: 0 0 20px rgba(208,0,255,0.4); }
        .btn-start:hover { background: #f080ff; transform: scale(1.02); }

        .btn-menu {
            position: absolute; top: 15px; right: 15px; width: 45px; height: 45px;
            background: rgba(0,0,0,0.4); border: 2px solid #d000ff; color: #d000ff;
            border-radius: 50%; font-size: 24px; display: none;
            align-items: center; justify-content: center; z-index: 5;
            padding: 0; margin: 0;
        }
        .btn-menu:hover { background: #d000ff; color: white; }

        #hud {
            position: absolute; top: 20px; width: 100%; text-align: center; pointer-events: none;
        }
        .hp-bar-container {
            width: 300px; height: 20px; background: rgba(255,255,255,0.1);
            margin: 0 auto; border-radius: 10px; overflow: hidden; border: 1px solid #555;
        }
        #hp-bar {
            width: 100%; height: 100%; background: linear-gradient(90deg, #ff0055, #ff5500);
            transition: width 0.2s;
        }
        #status-text { margin-top: 5px; font-size: 14px; color: #aaa; letter-spacing: 2px; }

    </style>
</head>
<body>

    <div id="hud" style="display:none;">
        <div class="hp-bar-container"><div id="hp-bar"></div></div>
        <div id="status-text">CORE INTEGRITY</div>
    </div>

    <button class="btn-menu" id="btn-menu" onclick="Game.pause()">⏸</button>

    <div id="ui-layer">
        <div id="panel">
            <h2>Galaxy Breaker</h2>

            <div class="group">
                <label>Количество орбит: <span id="v-orbits" class="val">5</span></label>
                <input type="range" min="1" max="8" value="5" oninput="UI.upd('orbits', this.value)">
            </div>

            <div class="group">
                <label>Плотность планет: <span id="v-density" class="val">6</span></label>
                <input type="range" min="3" max="15" value="6" oninput="UI.upd('density', this.value)">
            </div>

            <div class="group">
                <label>Скорость вращения: <span id="v-rot" class="val">1.0</span></label>
                <input type="range" min="0.1" max="3.0" step="0.1" value="1.0" oninput="UI.upd('rot', this.value)">
            </div>

            <div class="group">
                <label>Прочность планет: <span id="v-hp" class="val">2</span></label>
                <input type="range" min="1" max="5" value="2" oninput="UI.upd('hp', this.value)">
                <div style="font-size:10px; color:#888; text-align:right">Ударов для уничтожения</div>
            </div>

            <hr style="border-color: #4a2b75; opacity: 0.5;">

            <div class="group">
                <label>Скорость мяча: <span id="v-speed" class="val">8</span></label>
                <input type="range" min="4" max="25" value="8" oninput="UI.upd('speed', this.value)">
            </div>

            <div class="group">
                <label>Размер мяча: <span id="v-size" class="val">10</span></label>
                <input type="range" min="5" max="25" value="10" oninput="UI.upd('size', this.value)">
            </div>

            <div class="group">
                <label>Упругость (Отскок): <span id="v-bounce" class="val">1.0</span></label>
                <input type="range" min="0.8" max="1.2" step="0.05" value="1.0" oninput="UI.upd('bounce', this.value)">
            </div>

            <button class="btn-start" onclick="Game.start()">ЗАПУСК СИМУЛЯЦИИ</button>
        </div>
    </div>

    <canvas id="canvas"></canvas>

<script>
    // --- ЗВУК (Synth) ---
    const AudioEngine = {
        ctx: null,
        init() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
        play(freq, type, dur) {
            if(!this.ctx) return;
            const o = this.ctx.createOscillator();
            const g = this.ctx.createGain();
            o.type = type;
            o.frequency.setValueAtTime(freq, this.ctx.currentTime);
            // Плавное затухание
            g.gain.setValueAtTime(0.1, this.ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
            o.connect(g); g.connect(this.ctx.destination);
            o.start(); o.stop(this.ctx.currentTime + dur);
        },
        hitWall() { this.play(100, 'square', 0.1); },
        hitPlanet() { this.play(200 + Math.random()*200, 'sawtooth', 0.1); },
        destroyPlanet() { this.play(100 + Math.random()*50, 'square', 0.3); },
        hitCore() { 
            this.play(50, 'sawtooth', 0.4); 
            // Эффект вибрации звука
            setTimeout(()=>this.play(40, 'sawtooth', 0.3), 50);
        },
        win() { 
            let now = this.ctx.currentTime;
            [440, 554, 659, 880].forEach((f, i) => {
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.type = 'triangle';
                o.frequency.value = f;
                g.gain.setValueAtTime(0.1, now + i*0.1);
                g.gain.exponentialRampToValueAtTime(0.001, now + i*0.1 + 1);
                o.connect(g); g.connect(this.ctx.destination);
                o.start(now + i*0.1); o.stop(now + i*0.1 + 1);
            });
        }
    };

    // --- НАСТРОЙКИ ---
    const CFG = {
        orbits: 5,
        density: 6,
        rotSpeed: 1.0,
        planetHP: 2,
        ballSpeed: 8,
        ballSize: 10,
        bounce: 1.0,
        coreHP: 100
    };

    // --- КЛАССЫ ---

    class Particle {
        constructor(x, y, color, speed) {
            this.x = x; this.y = y;
            const a = Math.random() * Math.PI * 2;
            const s = Math.random() * speed;
            this.vx = Math.cos(a) * s;
            this.vy = Math.sin(a) * s;
            this.life = 1.0;
            this.color = color;
            this.decay = 0.02 + Math.random()*0.03;
        }
        update() {
            this.x += this.vx; this.y += this.vy;
            this.life -= this.decay;
        }
        draw(ctx) {
            ctx.globalAlpha = Math.max(0, this.life);
            ctx.fillStyle = this.color;
            ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI*2); ctx.fill();
            ctx.globalAlpha = 1;
        }
    }

    class Planet {
        constructor(orbitIndex, angle, hp) {
            this.orbitIndex = orbitIndex;
            this.angle = angle;
            this.maxHP = hp;
            this.hp = hp;

            // Расстояние от центра зависит от номера орбиты
            this.dist = 80 + (orbitIndex * 45); 
            this.radius = 12 + Math.random() * 8; // Случайный размер

            // Цвет (от розового к фиолетовому)
            this.hue = 260 + (orbitIndex * 15);
        }

        update(cx, cy) {
            // Вращение (чем дальше, тем медленнее или наоборот - сделаем чередование)
            let dir = this.orbitIndex % 2 === 0 ? 1 : -1;
            // Скорость зависит от настроек
            this.angle += (CFG.rotSpeed * 0.01 * dir);

            // Вычисляем координаты
            this.x = cx + Math.cos(this.angle) * this.dist;
            this.y = cy + Math.sin(this.angle) * this.dist;
        }

        draw(ctx) {
            const saturation = 50 + (this.hp / this.maxHP) * 50;
            const light = 30 + (this.hp / this.maxHP) * 40;

            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
            ctx.fillStyle = `hsl(${this.hue}, ${saturation}%, ${light}%)`;
            ctx.shadowColor = `hsl(${this.hue}, 100%, 50%)`;
            ctx.shadowBlur = 10;
            ctx.fill();
            ctx.shadowBlur = 0;

            // Индикатор трещин (если hp мало)
            if (this.hp < this.maxHP) {
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(this.x - this.radius/2, this.y);
                ctx.lineTo(this.x + this.radius/2, this.y);
                ctx.stroke();
            }
        }
    }

    class Core {
        constructor() {
            this.maxHP = 50; // Стандарт
            this.hp = 50;
            this.radius = 40;
            this.pulse = 0;
        }
        reset() {
            this.hp = 50;
        }
        update() {
            this.pulse += 0.05;
        }
        draw(ctx, cx, cy) {
            const r = this.radius + Math.sin(this.pulse) * 3;

            // Градиент ядра
            const grad = ctx.createRadialGradient(cx, cy, r*0.2, cx, cy, r);
            grad.addColorStop(0, '#fff');
            grad.addColorStop(0.5, '#ff0055');
            grad.addColorStop(1, '#550022');

            ctx.beginPath();
            ctx.arc(cx, cy, r, 0, Math.PI*2);
            ctx.fillStyle = grad;
            ctx.shadowColor = '#ff0055';
            ctx.shadowBlur = 30;
            ctx.fill();
            ctx.shadowBlur = 0;

            // Текст HP
            ctx.fillStyle = '#fff';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText((this.hp/this.maxHP*100).toFixed(0) + '%', cx, cy);
        }
    }

    class Ball {
        constructor() {
            this.reset();
        }
        reset() {
            this.x = 50; this.y = 50; // Старт в углу
            // Случайный вектор, но направленный в центр
            this.vx = 2 + Math.random()*2;
            this.vy = 2 + Math.random()*2;
            this.normalizeSpeed();
            this.trail = [];
        }

        normalizeSpeed() {
            const mag = Math.sqrt(this.vx*this.vx + this.vy*this.vy);
            this.vx = (this.vx/mag) * CFG.ballSpeed;
            this.vy = (this.vy/mag) * CFG.ballSpeed;
        }

        update(w, h) {
            this.x += this.vx;
            this.y += this.vy;

            // Отскок от стен (Screen Bounce)
            let hit = false;
            if (this.x < CFG.ballSize) { this.x = CFG.ballSize; this.vx *= -1; hit=true; }
            if (this.x > w - CFG.ballSize) { this.x = w - CFG.ballSize; this.vx *= -1; hit=true; }
            if (this.y < CFG.ballSize) { this.y = CFG.ballSize; this.vy *= -1; hit=true; }
            if (this.y > h - CFG.ballSize) { this.y = h - CFG.ballSize; this.vy *= -1; hit=true; }

            if(hit) AudioEngine.hitWall();

            // Трейл
            this.trail.push({x: this.x, y: this.y});
            if(this.trail.length > 20) this.trail.shift();
        }

        draw(ctx) {
            // Рисуем хвост
            if(this.trail.length > 1) {
                ctx.beginPath();
                ctx.moveTo(this.trail[0].x, this.trail[0].y);
                for(let p of this.trail) ctx.lineTo(p.x, p.y);
                ctx.lineWidth = CFG.ballSize / 2;
                ctx.strokeStyle = 'rgba(208, 0, 255, 0.4)';
                ctx.lineCap = 'round';
                ctx.stroke();
            }

            ctx.beginPath();
            ctx.arc(this.x, this.y, CFG.ballSize, 0, Math.PI*2);
            ctx.fillStyle = '#fff';
            ctx.shadowColor = '#d000ff';
            ctx.shadowBlur = 15;
            ctx.fill();
            ctx.shadowBlur = 0;
        }

        bounce(nx, ny) {
            // Отражение вектора
            const dot = this.vx * nx + this.vy * ny;
            this.vx = this.vx - 2 * dot * nx;
            this.vy = this.vy - 2 * dot * ny;
            // Применение упругости
            this.vx *= CFG.bounce;
            this.vy *= CFG.bounce;
            // Возврат к нормальной скорости (чтобы не затухал или не ускорялся бесконечно)
            this.normalizeSpeed();
        }
    }

    // --- ДВИЖОК ---
    const Game = {
        canvas: document.getElementById('canvas'),
        ctx: document.getElementById('canvas').getContext('2d'),
        w: 0, h: 0, cx: 0, cy: 0,
        running: false,

        ball: new Ball(),
        core: new Core(),
        planets: [],
        particles: [],

        init() {
            this.resize();
            window.addEventListener('resize', () => this.resize());
            this.loop = this.loop.bind(this);
            requestAnimationFrame(this.loop);
        },

        resize() {
            this.w = window.innerWidth;
            this.h = window.innerHeight;
            this.canvas.width = this.w;
            this.canvas.height = this.h;
            this.cx = this.w / 2;
            this.cy = this.h / 2;
        },

        spawnPlanets() {
            this.planets = [];
            for(let orb=0; orb<CFG.orbits; orb++) {
                // Количество планет на орбите увеличивается с радиусом
                let count = CFG.density + orb * 2; 
                for(let i=0; i<count; i++) {
                    let angle = (Math.PI*2 / count) * i;
                    // Смещение для красоты
                    angle += orb; 
                    this.planets.push(new Planet(orb, angle, CFG.planetHP));
                }
            }
        },

        start() {
            AudioEngine.init();
            document.getElementById('ui-layer').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            document.getElementById('btn-menu').style.display = 'flex';

            this.core.reset();
            this.ball.reset();
            this.spawnPlanets();
            this.particles = [];

            this.running = true;
            this.updateHUD();
        },

        pause() {
            this.running = false;
            document.getElementById('ui-layer').style.display = 'flex';
        },

        spawnExplosion(x, y, color, amount) {
            for(let i=0; i<amount; i++) {
                this.particles.push(new Particle(x, y, color, 5));
            }
        },

        checkCollisions() {
            // 1. Проверка столкновения с ЯДРОМ
            const dxC = this.ball.x - this.cx;
            const dyC = this.ball.y - this.cy;
            const distC = Math.sqrt(dxC*dxC + dyC*dyC);

            if (distC < this.core.radius + CFG.ballSize) {
                // Удар по ядру
                AudioEngine.hitCore();
                this.spawnExplosion(this.ball.x, this.ball.y, '#ff0055', 10);

                // Отскок
                let nx = dxC / distC;
                let ny = dyC / distC;
                this.ball.bounce(nx, ny);

                // Выталкиваем
                const overlap = (this.core.radius + CFG.ballSize) - distC;
                this.ball.x += nx * overlap;
                this.ball.y += ny * overlap;

                // Урон
                this.core.hp--;
                this.updateHUD();

                if(this.core.hp <= 0) {
                    this.gameOver(true);
                }
            }

            // 2. Проверка столкновения с ПЛАНЕТАМИ
            for (let i = this.planets.length - 1; i >= 0; i--) {
                let p = this.planets[i];
                const dx = this.ball.x - p.x;
                const dy = this.ball.y - p.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                const minDist = p.radius + CFG.ballSize;

                if (dist < minDist) {
                    // Удар
                    let nx = dx / dist;
                    let ny = dy / dist;
                    this.ball.bounce(nx, ny);

                    // Выталкиваем мяч
                    const overlap = minDist - dist;
                    this.ball.x += nx * overlap;
                    this.ball.y += ny * overlap;

                    // Логика повреждения планеты
                    p.hp--;
                    if (p.hp <= 0) {
                        // Уничтожение
                        AudioEngine.destroyPlanet();
                        this.spawnExplosion(p.x, p.y, `hsl(${p.hue}, 100%, 70%)`, 8);
                        this.planets.splice(i, 1);
                    } else {
                        // Просто удар
                        AudioEngine.hitPlanet();
                        p.radius *= 0.9; // Чуть уменьшаем
                    }
                }
            }
        },

        updateHUD() {
            const pct = Math.max(0, (this.core.hp / this.core.maxHP) * 100);
            document.getElementById('hp-bar').style.width = pct + '%';
        },

        gameOver(win) {
            this.running = false;
            AudioEngine.win();
            // Показываем меню снова
            setTimeout(() => {
                document.getElementById('ui-layer').style.display = 'flex';
                document.querySelector('h2').innerText = win ? "MISSION COMPLETE" : "GAME OVER";
            }, 1000);

            // Финальный взрыв
            this.spawnExplosion(this.cx, this.cy, '#fff', 100);
        },

        update() {
            if(!this.running) return;

            this.core.update();
            this.ball.update(this.w, this.h);

            this.planets.forEach(p => p.update(this.cx, this.cy));
            this.checkCollisions();

            // Частицы
            for(let i=this.particles.length-1; i>=0; i--) {
                this.particles[i].update();
                if(this.particles[i].life <= 0) this.particles.splice(i, 1);
            }
        },

        draw() {
            // След (motion blur effect)
            this.ctx.fillStyle = 'rgba(8, 0, 16, 0.4)';
            this.ctx.fillRect(0, 0, this.w, this.h);

            // Рисуем слабые линии орбит для красоты
            this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            this.ctx.lineWidth = 1;
            for(let i=0; i<CFG.orbits; i++) {
                this.ctx.beginPath();
                this.ctx.arc(this.cx, this.cy, 80 + (i * 45), 0, Math.PI*2);
                this.ctx.stroke();
            }

            this.core.draw(this.ctx, this.cx, this.cy);
            this.planets.forEach(p => p.draw(this.ctx));
            this.particles.forEach(p => p.draw(this.ctx));
            this.ball.draw(this.ctx);
        },

        loop() {
            this.update();
            this.draw();
            requestAnimationFrame(this.loop);
        }
    };

    // --- UI ЛОГИКА ---
    const UI = {
        upd(id, val) {
            document.getElementById('v-'+id).innerText = val;
            val = Number(val);
            if(id === 'orbits') CFG.orbits = val;
            if(id === 'density') CFG.density = val;
            if(id === 'rot') CFG.rotSpeed = val;
            if(id === 'hp') CFG.planetHP = val;
            if(id === 'speed') CFG.ballSpeed = val;
            if(id === 'size') CFG.ballSize = val;
            if(id === 'bounce') CFG.bounce = val;
        }
    };

    Game.init();

</script>
</body>
</html>
